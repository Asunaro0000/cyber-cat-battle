<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cyber Cat Battle â€” Album & Lightbox</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{ --header-h:60px; --actions-h:240px }
body{
  background:url('./assets/fire-cat/bg.webp') center/cover no-repeat,
             linear-gradient(135deg,#0a0e27 0%,#1a1a2e 50%,#16213e 100%);
  color:#fff; font-family:Arial, sans-serif; height:100vh; overflow:hidden;
}
.battle-container{width:100vw;height:100vh;display:flex;flex-direction:column;background:rgba(0,0,0,.2)}
.battle-header{height:var(--header-h);background:rgba(0,0,0,.85);padding:10px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #64ffda;flex-shrink:0}
.turn-info{color:#64ffda;font-size:1.1rem;font-weight:bold}
.battle-controls{display:flex;gap:10px;flex-wrap:wrap}
.control-btn{padding:8px 16px;background:rgba(100,255,218,.2);border:1px solid #64ffda;border-radius:20px;color:#64ffda;cursor:pointer;transition:.2s;font-size:.9rem}
.control-btn:hover{background:rgba(100,255,218,.35);transform:translateY(-2px)}
.control-btn:disabled{opacity:.45;cursor:not-allowed}

/* â˜… Albumãƒœã‚¿ãƒ³ã ã‘è‰²ã‚’å¼·èª¿ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰ç³»ï¼‰ */
#albumBtn{
  background: linear-gradient(135deg, #ffd54f, #ff8f00);
  border-color: #ffca28;
  color: #1d1200;
  box-shadow: 0 0 0 2px rgba(255, 213, 79, .25) inset;
}
#albumBtn:hover{
  background: linear-gradient(135deg, #ffe082, #ff6f00);
}
#albumBtn:disabled{
  /* è§£æ”¾å‰ã§ã‚‚ä»–ã‚ˆã‚Šç›®ç«‹ã¤è‰²å‘³ã‚’ç¶­æŒã—ã¤ã¤æ§ãˆã‚ã« */
  background: linear-gradient(135deg, #8a7440, #8a5a1f);
  border-color: #a6873a;
  color: #e6e0d5;
  opacity: .65; /* æ—¢å­˜ã® :disabled ã¨æ•´åˆ */
}


.battlefield{flex:1;display:grid;grid-template-columns:1fr 1fr;position:relative;min-height:0}
.battlefield::before{content:'';position:absolute;inset:0 auto 0 50%;width:2px;background:linear-gradient(to bottom,transparent,#64ffda,transparent);z-index:1}
.player-side,.enemy-side{display:flex;flex-direction:column;justify-content:center;align-items:center;padding:20px}
.enemy-side{background:linear-gradient(135deg,rgba(255,107,107,.10),rgba(238,90,36,.05))}
.player-side{background:linear-gradient(135deg,rgba(100,255,218,.10),rgba(69,183,209,.05))}
.character-name{font-size:1.1rem;font-weight:bold;color:#ccd6f6;margin-bottom:6px}
.enemy-meta{display:flex;gap:8px;align-items:center;margin-bottom:8px;color:#ffd37a;font-weight:bold}
.enemy-level{padding:2px 8px;border:1px solid #ffd37a;border-radius:999px;font-size:.85rem}
.enemy-atk{font-size:.85rem;opacity:.9}
.character-sprite{width:180px;height:180px;border-radius:20px;border:3px solid #64ffda;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-size:4rem;margin-bottom:15px;transition:.5s;overflow:hidden;position:relative}
.character-sprite img,.character-sprite video{width:100%;height:100%;object-fit:cover;border-radius:15px}
.icon-frame{position:absolute;inset:0;z-index:10;pointer-events:none}

.hp-bar-container{width:240px;margin-bottom:10px}
.hp-bar{width:100%;height:18px;background:rgba(0,0,0,.5);border-radius:10px;overflow:hidden;border:2px solid #64ffda}
.hp-fill{height:100%;background:linear-gradient(90deg,#00ff88,#64ffda);transition:width .8s ease,background .3s ease}
.hp-fill.yellow{background:linear-gradient(90deg,#ffaa00,#ffdd00)}
.hp-fill.red{background:linear-gradient(90deg,#ff4444,#ff6666)}
.hp-text{text-align:center;margin-top:5px;color:#ccd6f6;font-size:.9rem}

/* ãƒ•ãƒƒã‚¿ãƒ¼ï¼šãƒœã‚¿ãƒ³ç¾¤ï¼†ãƒ­ã‚° */
.battle-actions{height:var(--actions-h);background:rgba(0,0,0,.92);border-top:2px solid #64ffda;display:grid;grid-template-columns:2fr 1fr;gap:10px;padding:10px;flex-shrink:0}
@media (max-height:900px){ :root{ --actions-h:200px } .character-sprite{width:165px;height:165px}}
@media (max-height:820px){ :root{ --actions-h:180px } .character-sprite{width:155px;height:155px}}
@media (max-height:700px){ :root{ --actions-h:160px } .character-sprite{width:145px;height:145px}}
.action-buttons{
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  grid-template-rows: repeat(3, 1fr); /* â† 4 â†’ 3 ã«ä¿®æ­£ */
  gap: 6px;
  height: 100%;
  align-content: stretch;
  align-items: stretch;
}
.action-btn{
  background:url('./assets/ui/cmd-bg.webp') center/cover no-repeat,
             linear-gradient(135deg,#667eea,#764ba2);
  border:2px solid #64ffda;border-radius:10px;color:#fff;cursor:pointer;transition:.2s;font-weight:bold;font-size:.9rem;
  display:flex;align-items:center;justify-content:center;gap:10px;position:relative;padding:8px;min-height:60px
}
.action-btn::before{content:'';position:absolute;inset:0;background:rgba(0,0,0,.25);border-radius:8px;z-index:1}
.action-icon,.action-text{position:relative;z-index:2}
.action-icon{width:40px;height:40px;border-radius:8px;background:rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0;border:1px solid rgba(255,255,255,.3)}
.action-icon img{width:100%;height:100%;object-fit:contain}
.action-text{display:flex;flex-direction:column;gap:2px;text-align:center}
.action-title{font-size:1rem;font-weight:bold}
.action-cost{font-size:.8rem;opacity:.8}
.action-btn:disabled{
  opacity:.5;cursor:not-allowed;
  background:url('./assets/ui/cmd-bg.webp') center/cover no-repeat,
             linear-gradient(135deg,#555,#666);
}
.action-btn:not(:disabled):hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(100,255,218,.28)}

.battle-info{
  display: grid !important;
  grid-template-rows: auto 1fr;
  gap: 6px;       /* â† å·¦ã®ãƒœã‚¿ãƒ³ç¾¤ã¨åˆã‚ã›ã¦ 6px ã«çµ±ä¸€ */
  min-height: 0;
}
.energy-bar{background:rgba(100,255,218,.12);border:2px solid #64ffda;border-radius:10px;padding:12px}
.energy-title{color:#64ffda;font-weight:bold;margin-bottom:8px;font-size:.9rem}
.energy-orbs{display:flex;gap:4px}
.energy-orb{width:18px;height:18px;border-radius:50%;border:2px solid #64ffda;background:transparent;transition:.2s}
.energy-orb.filled{background:#64ffda;box-shadow:0 0 8px rgba(100,255,218,.5)}
/* ãƒ­ã‚°æ ã¯ä¸­å¤®å¯„ã›ã®ã¾ã¾ï¼ˆå¿…è¦ãªã‚‰æ®‹ã™ï¼‰ */
.battle-log{
  /* â˜… æ ã¨èƒŒæ™¯ã‚’å¾©æ´»ã•ã›ã¤ã¤ä¸­å¤®å¯„ã›ã‚‚ç¶­æŒ */
  background: rgba(100,255,218,.06);
  border: 1px solid rgba(100,255,218,.35);
  border-radius: 10px;
  padding: 12px;

  display: flex !important;
  align-items: center;
  justify-content: center;

  overflow: hidden;
  min-height: 0;
}
.log-text{
  margin: 0;
  text-align: center;
}

/* ä¸­å¤®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆæ¼”å‡ºç”¨ï¼‰ */
.media-overlay{
  position:fixed;left:50%;top:50%;width:400px;height:400px;
  transform:translate(-50%,-50%);pointer-events:none;z-index:1000;opacity:0;transition:opacity .25s ease;
}
.media-overlay.show{opacity:1}
.media-overlay img,.media-overlay video{width:100%;height:100%;object-fit:contain}
.media-content{position:relative;width:100%;height:100%}
.media-frame{position:absolute;inset:0;z-index:10;pointer-events:none}

/* ã‚¢ãƒ«ãƒãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« */
.album-modal{
  position:fixed;left:0;top:var(--header-h);width:100vw;height:calc(100vh - var(--header-h));
  background:rgba(0,0,0,.96);border-top:2px solid #64ffda;z-index:2000;display:none;overflow:auto;padding:14px;
}
.album-header{display:flex;justify-content:space-between;align-items:center;color:#64ffda;font-weight:bold;margin-bottom:10px}
.album-close{padding:6px 10px;border:1px solid #64ffda;background:transparent;color:#64ffda;border-radius:8px;cursor:pointer}
.album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.album-section{grid-column:1/-1;margin:6px 0 2px;color:#64ffda;font-weight:bold}
.album-card{background:rgba(100,255,218,.08);border:1px solid rgba(100,255,218,.3);border-radius:10px;padding:8px}
.album-thumb{width:100%;aspect-ratio:1/1;background:#000;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.album-thumb img,.album-thumb video{width:100%;height:100%;object-fit:contain}
.album-caption{margin-top:6px;font-size:.85rem;color:#a8b2d1;text-align:center}

/* Lightboxï¼ˆæ‹¡å¤§é–²è¦§ï¼‰ */
.lightbox{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.86); z-index:3000; }
.lightbox.show{ display:flex; }
.lightbox-content{ position:relative; max-width:92vw; max-height:92vh; }
.lightbox-content img,.lightbox-content video{ width:100%; height:100%; object-fit:contain; max-height:86vh; }
.lightbox-caption{ margin-top:8px; text-align:center; color:#a8b2d1; font-size:.9rem; }
.lightbox-close{ position:absolute; top:-40px; right:0; padding:6px 10px; border:1px solid #64ffda; background:rgba(0,0,0,.6); color:#64ffda; border-radius:8px; cursor:pointer; }

/* è£…é£¾ */
#buffEmoji{margin-left:8px;font-size:1.05rem;vertical-align:middle;filter:drop-shadow(0 0 2px rgba(100,255,218,.4))}
.prism{background:linear-gradient(135deg,#ff6b6b,#4ecdc4,#45b7d1,#96ceb4);background-size:400% 400%;animation:gradientShift 3s ease-in-out infinite}
.shadow{background:linear-gradient(135deg,#6c5ce7,#a29bfe)}
@keyframes gradientShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}

/* æ•—åŒ—ã—ãŸã‚­ãƒ£ãƒ©ã®è¦‹ãŸç›®ï¼ˆã‚¯ãƒªãƒƒã‚¯ä¸å¯ãƒ»ã‚°ãƒ¬ãƒ¼ï¼‰ */
.character-option.is-defeated{
  opacity:.45;
  filter:grayscale(100%);
  pointer-events:none;
}

/* ==== å³ä¸‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒ­ã‚°ï¼‰ä½ç½®ï¼†è¦‹åˆ‡ã‚Œä¿®æ­£ ==== */

/* å³ã‚«ãƒ©ãƒ ã‚’gridã«ã—ã¦ã€Œä¸Šï¼šã‚¨ãƒŠã‚¸ãƒ¼ã€ã€Œä¸‹ï¼šãƒ­ã‚°ã€ã§è‡ªå‹•é…åˆ†ã€‚
   min-height:0 ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§é«˜ã•ãŒè¶³ã‚Šãªã„ç’°å¢ƒã§ã‚‚è¦‹åˆ‡ã‚Œãªã„ã€‚ */
.battle-info{
  display: grid !important;
  grid-template-rows: auto 1fr;
  gap: 8px;
  min-height: 0;           /* â˜…é‡è¦ï¼šå­è¦ç´ ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼é˜²æ­¢ */
}

/* ãƒ­ã‚°æ ï¼šå¸¸ã«ä¸­å¤®å¯„ã›ãƒ»è¦‹åˆ‡ã‚Œé˜²æ­¢ */
.battle-log{
  display: flex !important;
  align-items: center;     /* å‚ç›´ä¸­å¤® */
  justify-content: center; /* æ°´å¹³ä¸­å¤®ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚’çœŸã‚“ä¸­ã«ï¼‰ */
  overflow: hidden;        /* ã¯ã¿å‡ºã—é˜²æ­¢ */
  min-height: 0;           /* â˜…é‡è¦ï¼šè¦ªgridå†…ã§ã®ç¸®ã¿è¨±å¯ */
}

/* ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸­å¤®å¯„ã›ã« */
.log-text{
  margin: 0;
  text-align: center;
}
/* ===== Mobile-first overrides ===== */


/* ã•ã‚‰ã«ç‹­ã„ç«¯æœ«ï¼ˆæ¨ªå¹… 420px æœªæº€ï¼‰ã®æœ€çµ‚èª¿æ•´ */
@media (max-width: 420px) {
  .action-buttons { gap: 6px; }
  .action-btn { min-height: 58px; padding: 8px; }
  .action-icon { width: 32px; height: 32px; }
  .hp-bar-container { width: 90vw; }
}
/* ===== Phone portrait first (å„ªå…ˆ: ç¸¦æŒã¡) ===== */

/* ã•ã‚‰ã«ç‹­ã„ç«¯æœ«ï¼ˆ~375pxï¼‰ã®â€œæ¥µå°â€èª¿æ•´ */
@media (max-width: 375px) and (orientation: portrait) {
  .action-buttons { gap: 5px; grid-template-rows: repeat(3, minmax(40px,1fr)); }
  .action-btn { min-height: 40px; padding: 4px; font-size: .74rem; }
  .action-icon { width: 22px; height: 22px; }
  .character-sprite { width: 128px; height: 128px; }
  .hp-bar-container { width: 94vw; }
}
/* ===== Phone portrait first (å„ªå…ˆ: ç¸¦æŒã¡) ===== */
/* ===== æœ€å°é™UIï¼šç¸¦æŒã¡ã‚¹ãƒãƒ›ç”¨ ===== */
/* ===== ã‚¹ãƒãƒ›ç¸¦ï¼šãƒœã‚¿ãƒ³ã¯ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ ===== */
@media (max-width: 768px) and (orientation: portrait) {
  /* ã‚°ãƒªãƒƒãƒ‰ã¯ 3åˆ—Ã—2è¡Œï¼ˆçœã‚¹ãƒšãƒ¼ã‚¹ï¼‰ or 2åˆ—Ã—3è¡Œã©ã¡ã‚‰ã§ã‚‚OKã€‚ã“ã“ã§ã¯ 3Ã—2 ã«ã—ã¾ã™ */
  .action-buttons {
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(2, minmax(44px, 1fr));
    gap: 6px;
  }

  /* ãƒœã‚¿ãƒ³ã¯æ­£æ–¹å½¢ï¼†ã‚»ãƒ³ã‚¿ãƒ¼å¯„ã›ã€ãƒ†ã‚­ã‚¹ãƒˆã¯éè¡¨ç¤º */
  .action-btn {
    min-height: 44px;
    aspect-ratio: 1 / 1;         /* æ­£æ–¹å½¢ */
    padding: 0;
    display: grid;
    place-items: center;
    border-radius: 8px;
    font-size: 0;                /* æ–‡å­—ã®é«˜ã•åˆ†ã®ã‚ºãƒ¬é˜²æ­¢ */
  }

  .action-icon {
    width: 26px;
    height: 26px;
    font-size: 0;                /* çµµæ–‡å­—ç”¨ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºç„¡åŠ¹åŒ– */
    border: none;                /* ä½™è¨ˆãªæ ã‚’æ¶ˆã™ï¼ˆå¿…è¦ãªã‚‰æ®‹ã—ã¦OKï¼‰ */
    background: transparent;
  }
  .action-icon img { width: 100%; height: 100%; object-fit: contain; }

  /* ãƒ†ã‚­ã‚¹ãƒˆã¯DOMã«æ®‹ã™ãŒç”»é¢ã§ã¯éè¡¨ç¤ºï¼ˆéŸ³å£°èª­ã¿ä¸Šã’ã¯ aria-label ã§æ‹…ä¿ï¼‰ */
  .action-text { 
    position: absolute !important;
    width: 1px; height: 1px; overflow: hidden;
    clip: rect(0 0 0 0); white-space: nowrap;
  }
}
/* ===== ç¸¦æŒã¡ï¼šHPãƒãƒ¼ã‚’çŸ­ãï¼†ç´°ã ===== */
@media (max-width: 768px) and (orientation: portrait) {
  /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼/æ•µã¨ã‚‚HPãƒãƒ¼ã®æ¨ªå¹…ã‚’ã•ã‚‰ã«çŸ­ã */
  .hp-bar-container {
    width: min(64vw, 260px);   /* â† ä»¥å‰ã‚ˆã‚ŠçŸ­ã */
    margin: 2px auto 6px;
  }
  .hp-bar {
    height: 8px;               /* â† ç´°ã */
    border-width: 1px;         /* æ ç·šã‚‚ç´°ã */
  }
  .hp-text {
    font-size: .72rem;         /* æ•°å­—ã‚‚å°‘ã—å°ã•ã */
  }
}
/* ===== æ¨ªå‘ãï¼šä¸‹1è¡Œã«UIã‚’ã¾ã¨ã‚ã‚‹ ===== */
@media (orientation: landscape) and (max-width: 1024px) {
  html, body { height: 100svh; overflow: hidden; }
  .battle-container {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  /* æˆ¦å ´ã‚’æœ€å¤§åŒ–ï¼ˆä¸Šä¸‹ã«ã—ã‹ãªã„æ§‹æˆã«ã™ã‚‹ï¼‰ */
  .battlefield {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    align-items: center;
    padding: 8px;
  }
  .character-sprite {
    width: min(40vw, 240px);
    height: min(40vw, 240px);
  }
  .hp-bar-container {
    width: 140px;
    margin: 4px auto;
  }
  .hp-bar { height: 8px; }
  .hp-text { font-size: 0.7rem; }

  /* ä¸‹æ®µã®UIã‚’1è¡Œã«ã¾ã¨ã‚ã‚‹ */
  .battle-actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 6px;
    padding: 4px 6px;
    background: rgba(0,0,0,.9);
    height: 52px;
  }

  /* ã‚³ãƒãƒ³ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ¨ªä¸€åˆ— */
  .action-buttons {
    display: flex;
    gap: 6px;
  }
  .action-btn {
    width: 42px;
    height: 42px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
  }
  .action-icon {
    width: 24px;
    height: 24px;
  }
  .action-text { display: none; } /* ãƒ†ã‚­ã‚¹ãƒˆã¯éè¡¨ç¤º */

  /* ã‚¨ãƒŠã‚¸ãƒ¼ã‚’æ¨ªä¸¦ã³ã§å°ã•ã */
  .energy-bar {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 0;
    background: transparent;
    border: none;
  }
  .energy-title {
    font-size: 0.65rem;
    color: #64ffda;
  }
  .energy-orbs {
    display: flex;
    gap: 3px;
  }
  .energy-orb {
    width: 10px;
    height: 10px;
    border: 1px solid #64ffda;
  }
  .energy-orb.filled { background: #64ffda; }

  /* ãƒ­ã‚°ã‚’å³ç«¯ã« */
  .battle-log {
    flex: 1;
    min-height: auto;
    padding: 0 6px;
    font-size: 0.65rem;
    color: #a8b2d1;
    text-align: right;
    background: transparent;
    border: none;
  }
  .log-text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* æ¼”å‡ºã¯ä¸­å¤®å¤§ãã */
  .media-overlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }
  .media-overlay img, .media-overlay video {
    max-width: 80%;
    max-height: 80%;
    object-fit: contain;
  }
}
/* ===== Landscape: æˆ¦å ´æœ€å¤§åŒ– ï¼† ä¸‹1è¡Œã«åœ§ç¸® ===== */
@media (orientation: landscape) and (max-width: 1024px) {

  html, body { height: 100svh; overflow: hidden; }
  .battle-container { height: 100svh; display: flex; flex-direction: column; }

  /* ä¸Šï¼æˆ¦å ´ã‚’æœ€å¤§ã€ä¸‹ï¼UIãƒãƒ¼ã‚’æœ€å° */
  .battlefield {
    flex: 1 1 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    align-items: center;
    padding: 6px 10px 2px;
    gap: 10px;
  }
  .battlefield::before { opacity: .5; } /* ä»•åˆ‡ã‚Šã¯è–„ã‚ï¼ˆä»»æ„ï¼‰ */

  /* â€”â€” ã‚­ãƒ£ãƒ©ï¼šå°ã•ã‚ï¼‹ä½™ç™½ã‚ã‚Š â€”â€” */
  .character-name { font-size: .9rem; margin-bottom: 2px; }
  .enemy-meta { gap: 6px; margin: 0 0 4px; transform: translateY(-2px); }
  .character-sprite {
    width: min(32vw, 180px);   /* å°ã•ã */
    height: min(32vw, 180px);
    margin: 4px 0 6px;         /* ä½™è£•ã‚’æ„Ÿã˜ã‚‹æœ€å°é™ã®é–“éš” */
  }
  .hp-bar-container { width: 130px; margin: 2px auto 6px; }
  .hp-bar { height: 8px; }
  .hp-text { font-size: .72rem; }

  /* â€”â€” ä¸‹éƒ¨UIãƒãƒ¼ï¼š1è¡Œãƒ»æœ€å° â€”â€” */
  .battle-actions {
    flex: 0 0 auto;
    height: 46px;                 /* ã•ã‚‰ã«ä½ã */
    padding: 4px 6px;
    background: rgba(0,0,0,.92);
    display: grid;
    grid-template-columns: auto auto 1fr; /* [ã‚³ãƒãƒ³ãƒ‰][ã‚¨ãƒŠã‚¸ãƒ¼][ãƒ­ã‚°] */
    align-items: center;
    gap: 6px;
    border-top: 1px solid rgba(100,255,218,.35);
  }

  /* ã‚³ãƒãƒ³ãƒ‰ï¼šã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ãƒ»æ¥µå° */
  .action-buttons {
    display: flex; gap: 6px; align-items: center;
  }
  .action-btn {
    width: 36px; height: 36px;   /* ã•ã‚‰ã«å°ã•ã */
    padding: 0; border-radius: 6px;
    display: grid; place-items: center;
  }
  .action-icon { width: 22px; height: 22px; }
  .action-text { display: none !important; }

  /* ã‚¨ãƒŠã‚¸ãƒ¼ï¼šæ°´å¹³ãƒ»æ¥µå° */
  .battle-info { display: contents; } /* ä¸­èº«ã‚’ç›´åˆ—é…ç½® */
  .energy-bar {
    display: flex; align-items: center; gap: 4px;
    padding: 0; background: transparent; border: none;
  }
  .energy-title { font-size: .65rem; color:#64ffda; }
  .energy-orbs { display: flex; gap: 3px; }
  .energy-orb { width: 9px; height: 9px; border:1px solid #64ffda; }
  .energy-orb.filled { background:#64ffda; }

  /* ãƒ­ã‚°ï¼šå³ç«¯1è¡Œã®ã¿ãƒ»è¶…å°ã•ã */
  .battle-log {
    justify-content: flex-end;
    background: transparent; border: none;
    min-height: auto; padding: 0 4px;
  }
  .log-text {
    font-size: .62rem; color:#a8b2d1;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  /* æ¼”å‡ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼šä¸­å¤®æœ€å¤§ã€ãƒãƒ¼ã«ã¯è¢«ã›ãªã„é«˜ã• */
  .media-overlay {
    position: fixed; left: 50%; top: calc(50% - 12px);
    transform: translate(-50%,-50%);
    width: 72%; max-height: 78%;
    pointer-events: none; z-index: 900;
  }
  .media-overlay img, .media-overlay video {
    width: 100%; height: auto; max-height: 78%; object-fit: contain;
  }
}
/* ===== Landscape: ã‚­ãƒ£ãƒ©ç¸®å°ãƒ»ã‚³ãƒãƒ³ãƒ‰æ­£æ–¹å½¢åŒ– ===== */
@media (orientation: landscape) and (max-width: 1024px) {

  /* æˆ¦å ´ã‚¨ãƒªã‚¢ */
  .battlefield {
    flex: 1 1 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    align-items: center;
    justify-items: center;
    padding: 4px 6px 0;
    gap: 6px;
  }

  /* ã‚­ãƒ£ãƒ©ç”»åƒã‚’ã•ã‚‰ã«å°ã•ãä¸­å¤®ã« */
  .character-sprite {
    width: min(28vw, 140px);
    height: min(28vw, 140px);
    margin: 2px 0;
  }

  /* ã‚­ãƒ£ãƒ©åã‚„ãƒ¡ã‚¿æƒ…å ±ã‚’å°ã•ã */
  .character-name { font-size: 0.75rem; margin-bottom: 2px; }
  .enemy-meta { gap: 4px; margin: 0 0 2px; }
  .enemy-level { font-size: 0.65rem; padding: 1px 4px; }
  #playerCharacterName { font-size: 0.75rem; }
  #buffEmoji { font-size: 0.8rem; }

  /* HPãƒãƒ¼ã‚’çŸ­ãï¼†ç´°ã */
  .hp-bar-container { width: 110px; margin: 2px auto; }
  .hp-bar { height: 6px; }
  .hp-text { font-size: 0.65rem; }

  /* ä¸‹ã®UIãƒãƒ¼ */
  .battle-actions {
    flex: 0 0 auto;
    height: 50px;                /* é«˜ã•ã‚’å›ºå®šã—ã¦éš™é–“ã‚’æ½°ã™ */
    padding: 0 6px;
    background: rgba(0,0,0,.95);
    display: grid;
    grid-template-columns: auto auto 1fr; /* [ã‚³ãƒãƒ³ãƒ‰][ã‚¨ãƒŠã‚¸ãƒ¼][ãƒ­ã‚°] */
    align-items: center;
    gap: 6px;
  }

  /* ã‚³ãƒãƒ³ãƒ‰ã‚’æ­£æ–¹å½¢ã‚¢ã‚¤ã‚³ãƒ³ã ã‘ã« */
  .action-buttons {
    display: flex; gap: 6px;
  }
  .action-btn {
    width: 40px;
    height: 40px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
  }
  .action-icon { width: 22px; height: 22px; }
  .action-text { display: none !important; }

  /* ã‚¨ãƒŠã‚¸ãƒ¼å°ã•ã */
  .energy-bar { display: flex; align-items: center; gap: 3px; padding: 0; }
  .energy-title { font-size: 0.6rem; }
  .energy-orbs { gap: 2px; }
  .energy-orb { width: 8px; height: 8px; }

  /* ãƒ­ã‚°æœ€å°åŒ– */
  .battle-log { min-height: auto; padding: 0 4px; }
  .log-text {
    font-size: 0.6rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
}
/* ===== Landscape fix: å°å‹åŒ– & 1è¡Œãƒãƒ¼ ===== */
@media (orientation: landscape) and (max-width: 1024px) {

  html, body { height: 100svh; overflow: hidden; }
  .battle-container { height: 100svh; display: flex; flex-direction: column; }

  /* æˆ¦å ´ï¼šã‚­ãƒ£ãƒ©ã•ã‚‰ã«å°ã•ããƒ»ä¸­å¤®ã«ä½™è£• */
  .battlefield{
    flex:1 1 auto;
    display:grid;
    grid-template-columns:1fr 1fr;
    align-items:center; justify-items:center;
    padding:4px 8px 0; gap:6px;
  }
  .character-name{ font-size:.7rem; margin-bottom:2px; }
  .enemy-meta{ gap:4px; margin:0 0 2px; }
  .enemy-level{ font-size:.62rem; padding:1px 4px; }
  #playerCharacterName{ font-size:.7rem }
  #buffEmoji{ font-size:.75rem }

  /* â†’ ã‚¢ã‚¤ã‚³ãƒ³ã‚‚ã£ã¨å°ã•ã */
  .character-sprite{
    width:min(24vw, 120px);
    height:min(24vw, 120px);
    margin:2px 0;
  }
  .hp-bar-container{ width:96px; margin:2px auto }
  .hp-bar{ height:6px }
  .hp-text{ font-size:.6rem }

  /* ä¸‹ã®ãƒãƒ¼ï¼šèƒŒæ™¯ãŒè¦—ã‹ãªã„ã‚ˆã†é«˜ã•å›ºå®šï¼†è©°ã‚ã‚‹ */
  .battle-actions{
    flex:0 0 auto;
    height:44px;                      /* â† ä½ãå›ºå®š */
    padding:0 6px;                     /* â† ä½™ç™½æœ€å° */
    background:rgba(0,0,0,.96);
    display:grid;
    grid-template-columns:auto 1fr;    /* [ã‚³ãƒãƒ³ãƒ‰] [ã‚¨ãƒŠã‚¸ãƒ¼+ãƒ­ã‚°] */
    align-items:center; gap:6px;
    border-top:1px solid rgba(100,255,218,.35);
  }

  /* ã‚³ãƒãƒ³ãƒ‰ï¼šæ­£æ–¹å½¢ï¼†ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ */
  .action-buttons{ display:flex; gap:6px; flex-wrap:nowrap; align-items:center; }
  .action-btn{
    width:34px; height:34px;          /* â† æ­£æ–¹å½¢ */
    padding:0; border-radius:6px;
    display:grid; place-items:center;
  }
  .action-icon{ width:20px; height:20px }
  .action-text{ display:none !important }   /* ãƒ†ã‚­ã‚¹ãƒˆæ¶ˆã— */

  /* å³å´ã®æƒ…å ±ã¯ä¸€åˆ—ã§ã€Œã‚¨ãƒŠã‚¸ãƒ¼â†’ãƒ­ã‚°ã€ */
  .battle-info{
    display:flex; align-items:center; gap:8px; justify-content:space-between;
    min-width:0;                       /* çœã‚¹ãƒšãƒ¼ã‚¹ã§æŠ˜ã‚Œãªã„ã‚ˆã†ã« */
  }
  .energy-bar{
    display:flex; align-items:center; gap:4px;
    padding:0; background:transparent; border:none;
  }
  .energy-title{ font-size:.6rem; color:#64ffda }
  .energy-orbs{ display:flex; gap:2px }
  .energy-orb{ width:8px; height:8px; border:1px solid #64ffda }
  .energy-orb.filled{ background:#64ffda }

  /* ãƒ­ã‚°ã¯ã‚¨ãƒŠã‚¸ãƒ¼ã®æ¨ªãƒ»1è¡Œæ¥µå° */
  .battle-log{
    flex:1; min-height:auto; padding:0 4px; background:transparent; border:none;
    display:flex; align-items:center; justify-content:flex-end;
  }
  .log-text{
    font-size:.6rem; color:#a8b2d1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  /* æ¼”å‡ºã¯ä¸­å¤®ï¼ˆä¸‹ãƒãƒ¼ã«è¢«ã‚‰ãªã„ï¼‰ */
  .media-overlay{
    position:fixed; left:50%; top:calc(50% - 10px);
    transform:translate(-50%,-50%); width:68%; max-height:78%;
    pointer-events:none; z-index:900;
  }
  .media-overlay img, .media-overlay video{ width:100%; height:auto; max-height:78%; object-fit:contain }
}
/* === Overlay: ç”»åƒãƒ»å‹•ç”»ãƒ»ã‚«ãƒƒãƒˆã‚¤ãƒ³ã‚’å®Œå…¨ä¸­å¤®ã« === */
.media-overlay{
  position:fixed !important;
  left:50% !important; top:50% !important;
  transform:translate(-50%,-50%) !important;
  width:min(68vw, 760px); max-height:78vh;
  pointer-events:none; z-index:900; opacity:1;
  display:flex; align-items:center; justify-content:center;
}
.media-overlay .media-content{ 
  width:100%; height:auto; max-height:78vh;
  display:flex; align-items:center; justify-content:center;
}
.media-overlay img,
.media-overlay video{
  max-width:100%; max-height:78vh; object-fit:contain; display:block;
}
/* ã‚‚ã—æ ç”»åƒï¼ˆframeï¼‰ã‚’é‡ã­ã‚‹å ´åˆã‚‚ä¸­å¤®ã«ä¸€è‡´ã•ã›ã‚‹ */
.media-overlay .media-frame{
  position:absolute; left:50%; top:50%;
  transform:translate(-50%,-50%);
  max-width:100%; max-height:100%; object-fit:contain; pointer-events:none;
}
/* === Landscape: æˆ¦å ´æœ€å¤§åŒ– & ä¸‹1è¡Œãƒãƒ¼ === */
@media (orientation: landscape) and (max-width: 1024px){

  html,body{height:100svh; overflow:hidden;}
  .battle-container{height:100svh; display:flex; flex-direction:column;}

  /* æˆ¦å ´ï¼šã‚­ãƒ£ãƒ©ã•ã‚‰ã«å°ã•ãï¼†ä¸­å¤®ã«ä½™è£• */
  .battlefield{
    flex:1 1 auto; display:grid; grid-template-columns:1fr 1fr;
    align-items:center; justify-items:center;
    padding:4px 8px 0; gap:6px;
  }
  .character-name{font-size:.7rem; margin-bottom:2px;}
  .enemy-meta{gap:4px; margin:0 0 2px;}
  .enemy-level{font-size:.62rem; padding:1px 4px;}
  #playerCharacterName{font-size:.7rem} #buffEmoji{font-size:.72rem}

  .character-sprite{ width:min(22vw, 110px); height:min(22vw,110px); margin:2px 0;}
  .hp-bar-container{width:92px; margin:2px auto;}
  .hp-bar{height:6px} .hp-text{font-size:.58rem}

  /* ä¸‹ã®ãƒãƒ¼ï¼šéš™é–“ã‚¼ãƒ­ï¼†[ã‚³ãƒãƒ³ãƒ‰][ã‚¨ãƒŠã‚¸ãƒ¼+ãƒ­ã‚°]ã‚’åŒä¸€è¡Œ */
  .battle-actions{
    flex:0 0 auto; height:42px; padding:0 6px;
    background:rgba(0,0,0,.98);
    display:grid; grid-template-columns:auto 1fr;
    align-items:center; gap:6px; border-top:1px solid rgba(100,255,218,.35);
  }

  /* ã‚³ãƒãƒ³ãƒ‰ï¼šå¿…ãšæ­£æ–¹å½¢ */
  .action-buttons{display:flex; gap:6px; align-items:center; flex-wrap:nowrap;}
  .action-btn{
    box-sizing:border-box;
    aspect-ratio:1/1;           /* â† æ­£æ–¹å½¢ã‚’å¼·åˆ¶ */
    width:32px; min-width:32px; height:auto;
    padding:0; border-radius:6px; display:grid; place-items:center;
  }
  .action-icon{width:20px; height:20px;}
  .action-text{display:none !important;}

  /* å³å´ï¼ã‚¨ãƒŠã‚¸ãƒ¼ï¼‹ãƒ­ã‚°ã‚’æ¨ªä¸¦ã³ãƒ»è©°ã‚ã‚‹ */
  .battle-info{ display:flex; align-items:center; gap:8px; flex-wrap:nowrap; min-width:0; }
  .energy-bar{
    display:flex; align-items:center; gap:4px; padding:0;
    background:transparent; border:none; flex:0 0 auto;
  }
  .energy-title{font-size:.58rem; color:#64ffda;}
  .energy-orbs{display:flex; gap:2px;} .energy-orb{width:8px; height:8px; border:1px solid #64ffda;}
  .energy-orb.filled{background:#64ffda;}

  /* ãƒ­ã‚°ã¯åŒä¸€è¡Œã«åã‚ã€è½ã¡ãã†ãªã‚‰ã•ã‚‰ã«åœ§ç¸® */
  .battle-log{
    flex:1 1 auto; min-height:auto; padding:0 4px;
    background:transparent; border:none; display:flex; align-items:center; justify-content:flex-end;
  }
  .log-text{ font-size:.58rem; color:#a8b2d1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* ã•ã‚‰ã«ç‹­ã„æ¨ªå¹…(<=812px)ã¯è¶…åœ§ç¸®ã—ã¦è½ã¡ãªã„ã‚ˆã†ã« */
  @media (max-width: 812px){
    .action-btn{ width:30px; min-width:30px; }
    .action-icon{ width:18px; height:18px;}
    .energy-title{font-size:.52rem;}
    .energy-orb{width:7px; height:7px;}
    .log-text{font-size:.54rem;}
    .battle-actions{ height:40px; }
  }
}
/* ===== Landscape æœ€çµ‚èª¿æ•´ï¼šæ­£æ–¹å½¢ãƒœã‚¿ãƒ³/æœ€ä¸‹éƒ¨å›ºå®š/ãƒ­ã‚°å³ç«¯ ===== */
@media (orientation: landscape) and (max-width: 1024px) {

  /* æˆ¦å ´å´ã¯ä¸‹ã®å›ºå®šãƒãƒ¼ã¶ã‚“ã ã‘ä½™ç™½ã‚’ç¢ºä¿ï¼ˆé‡ãªã‚Šé˜²æ­¢ï¼‰ */
  .battle-container { 
    padding-bottom: calc(46px + env(safe-area-inset-bottom));
  }

  /* ---- ã‚³ãƒãƒ³ãƒ‰ãƒãƒ¼ï¼šç”»é¢æœ€ä¸‹éƒ¨ã«å›ºå®šï¼†èƒŒæ™¯ã®è¦—ãã‚¼ãƒ­ ---- */
  .battle-actions {
    position: fixed; left: 0; right: 0; bottom: 0;
    height: 46px;                                  /* ãƒãƒ¼ã®é«˜ã• */
    padding: 0 8px calc(env(safe-area-inset-bottom));
    background: rgba(0,0,0,0.98);                  /* ä¸é€æ˜ã§è¦—ãé˜²æ­¢ */
    display: grid;
    grid-template-columns: auto 1fr;               /* [ã‚³ãƒãƒ³ãƒ‰] [ã‚¨ãƒŠã‚¸ãƒ¼+ãƒ­ã‚°] */
    align-items: center;
    gap: 8px;
    border-top: 1px solid rgba(100,255,218,.35);
    z-index: 50;
  }

  /* ---- ã‚³ãƒãƒ³ãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—ï¼šç¸¦é•·ã®æ /ä½™ç™½ã‚’ç„¡åŠ¹åŒ–ã—ã¦æ­£æ–¹å½¢ã«æƒãˆã‚‹ ---- */
  /* è¦ªã«é«˜ã•ãŒã‚ã‚‹ã¨å­ãŒå¼•ã£å¼µã‚‰ã‚Œã‚‹ã®ã§ã€æ˜ç¤ºçš„ã«é«˜ã•ã‚’æ±ºã‚ã‚‹ */
  .action-buttons {
    height: 34px;                                  /* ã‚¢ã‚¤ã‚³ãƒ³æ ã®é«˜ã• = æ­£æ–¹å½¢ã‚µã‚¤ã‚º */
    display: flex; align-items: center; gap: 6px;
    padding: 0; margin: 0;
    background: transparent !important;
    border: none !important; box-shadow: none !important;
  }

  /* å„ãƒœã‚¿ãƒ³ã‚’â€œæ­£æ–¹å½¢â€ã§å›ºå®šã€‚å¤–æ ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’0ã« */
  .action-btn {
    height: 100%;                                  /* â† è¦ªã® 34px ã«åˆã‚ã›ã‚‹ */
    aspect-ratio: 1 / 1;                           /* â† æ­£æ–¹å½¢ã‚’å¼·åˆ¶ */
    width: auto; min-width: 34px;                  /* Safariå¯¾ç­–ã§å¹…ã®ä¸‹é™ã‚‚æŒ‡å®š */
    padding: 0; border-radius: 6px;
    display: grid; place-items: center;
    box-sizing: border-box;
    background-clip: padding-box;
  }
  .action-text { display: none !important; }       /* ãƒ†ã‚­ã‚¹ãƒˆã¯éè¡¨ç¤º */
  .action-icon { width: 20px; height: 20px; }
  .action-icon img { width: 100%; height: 100%; object-fit: contain; }

  /* ---- å³ã‚«ãƒ©ãƒ ï¼šã‚¨ãƒŠã‚¸ãƒ¼ï¼‹ãƒ­ã‚°ã‚’åŒã˜è¡Œã«ã€‚ãƒ­ã‚°ã¯å³ç«¯1è¡Œãƒ»æ ç„¡ã— ---- */
  .battle-info { 
    display: flex; align-items: center; gap: 10px; 
    min-width: 0; /* å³ç«¯ã§ã®æŠ˜è¿”ã—æŠ‘åˆ¶ */
  }

  .energy-bar {
    display: flex; align-items: center; gap: 4px;
    padding: 0; background: transparent !important;
    border: none !important; box-shadow: none !important;
    flex: 0 0 auto;
  }
  .energy-title { font-size: .6rem; color: #64ffda; }
  .energy-orbs { display: flex; gap: 2px; }
  .energy-orb { width: 8px; height: 8px; border: 1px solid #64ffda; }
  .energy-orb.filled { background: #64ffda; }

  /* ãƒ­ã‚°ã¯æ ã‚’å¤–ã—ã¦å³ç«¯1è¡Œã«ãƒ”ã‚¿ãƒƒã¨é…ç½® */
  .battle-log {
    flex: 1 1 auto;
    min-height: auto; padding: 0;
    background: transparent !important;
    border: none !important; box-shadow: none !important;
    display: flex; align-items: center; justify-content: flex-end;
  }
  .log-text {
    font-size: .6rem; color: #a8b2d1;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  /* ---- æˆ¦å ´ï¼šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã•ã‚‰ã«å°ã•ãä¸­å¤®ã«ä½™è£• ---- */
  .battlefield {
    padding: 6px 10px 0; gap: 8px;
    display: grid; grid-template-columns: 1fr 1fr;
    align-items: center; justify-items: center;
  }
  .character-name { font-size: .7rem; margin-bottom: 2px; }
  .enemy-meta { gap: 4px; margin: 0 0 2px; }
  .enemy-level { font-size: .62rem; padding: 1px 4px; }
  #playerCharacterName { font-size: .7rem; } 
  #buffEmoji { font-size: .7rem; }

  .character-sprite {
    width: min(20vw, 100px);
    height: min(20vw, 100px);
    margin: 2px 0;
  }
  .hp-bar-container { width: 90px; margin: 2px auto; }
  .hp-bar { height: 6px; }
  .hp-text { font-size: .58rem; }
}

/* ã•ã‚‰ã«ç‹­ã„æ¨ªå¹…(<=812px)ã§ã¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’32pxè§’ã¾ã§åœ§ç¸® */
@media (orientation: landscape) and (max-width: 812px) {
  .action-buttons { height: 32px; gap: 5px; }
  .action-btn { min-width: 32px; }
  .action-icon { width: 18px; height: 18px; }
  .battle-actions { height: 42px; }
}
/* === ã‚³ãƒãƒ³ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³æ ã‚’ã•ã‚‰ã«å°ã•ã === */
.action-buttons {
  height: 30px;                /* å°å‹åŒ– */
  padding: 0; margin: 0;
  display: flex; gap: 4px;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

.action-btn {
  height: 100%;
  aspect-ratio: 1 / 1;          /* æ­£æ–¹å½¢ã‚’å¼·åˆ¶ */
  width: auto; min-width: 30px; /* Safariå¯¾ç­– */
  padding: 0;
  border-radius: 4px;
  display: grid; place-items: center;
  background: transparent !important;
  border: 1px solid rgba(100,255,218,.5); /* æ ã‚‚ç´°ã */
}

.action-icon {
  width: 18px; height: 18px;
}
.action-text { display: none !important; }

/* === ãƒãƒˆãƒ«ãƒ­ã‚°ã¯å³ç«¯1è¡Œã€ä½™ç™½ã‚’é™¤å» === */
.battle-log {
  flex: 1 1 auto;
  min-height: auto;
  padding: 0 2px;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  display: flex;
  align-items: center;
  justify-content: flex-end;
}
.log-text {
  font-size: .58rem;
  color: #a8b2d1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* === ã‚«ãƒƒãƒˆã‚¤ãƒ³æ¼”å‡ºä¸­ã¯ã‚³ãƒãƒ³ãƒ‰ã‚’éè¡¨ç¤ºã« === */
.media-overlay.active ~ .battle-actions .action-buttons {
  display: none !important;
}
/* === ã‚³ãƒãƒ³ãƒ‰ï¼šæ­£æ–¹å½¢ï¼†æœ€ä¸‹éƒ¨ã«å¯†ç€ === */
:root{
  --commands-h: 96px; /* å¿…è¦ã«å¿œã˜ã¦90ã€œ110ã§å¾®èª¿æ•´ */
}
.battle-actions{
  position: fixed;
  left: 0; right: 0; bottom: 0;
  height: var(--commands-h);
  display: grid;
  grid-template-columns: 1fr;
  align-items: end;
  padding: 6px 10px calc(6px + env(safe-area-inset-bottom));
  background: #02060a; /* é»’å¸¯ */
  z-index: 500;
}

/* ã‚³ãƒãƒ³ãƒ‰ãƒœã‚¿ãƒ³ï¼šæ­£æ–¹å½¢åŒ– */
.action-buttons{
  display: grid;
  grid-template-columns: repeat(5, minmax(0,1fr));
  gap: 8px;
  align-items: end;
}
.action-btn{
  aspect-ratio: 1 / 1;       /* â˜…æ­£æ–¹å½¢ã«å›ºå®š */
  min-height: 0;             /* é«˜ã•ã¯ã‚¢ã‚¹ãƒšã‚¯ãƒˆã§æ±ºå®š */
  padding: 6px;              /* ä½™ç™½ã¯æœ€å°é™ */
  border-radius: 12px;
}
.action-btn .action-icon{    /* ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã‚’å†…ãƒ•ã‚£ãƒƒãƒˆ */
  width: 100%; height: 100%;
}

/* ã‚¨ãƒŠã‚¸ãƒ¼ï¼†ãƒ­ã‚°ã‚’1è¡Œã«ã¾ã¨ã‚ã¦å³ã¸è©°ã‚ã‚‹ */
.energy-and-log{
  display:flex; align-items:center; justify-content:flex-end;
  gap: 12px; margin-top: 6px;
}
.energy-bar{ margin: 0; padding: 6px 10px; }
.energy-title{ font-size: 12px; margin: 0 6px 0 0; }
.energy-orbs{ gap: 6px; }
.energy-orb{ width: 12px; height: 12px; }

/* ãƒãƒˆãƒ«ãƒ­ã‚°ï¼šæ ã¯å¤–ã—ã¦å³ç«¯ã«å°ã•ãè¡¨ç¤º */
.battle-log{
  background: transparent; box-shadow: none; border: 0;
  padding: 0; margin: 0;
}
.battle-log .log-text{
  font-size: 12px; line-height: 1.2; opacity: .9;
  white-space: nowrap; text-overflow: ellipsis; overflow: hidden;
  max-width: 42vw;          /* å¿…è¦ãªã‚‰å¹…èª¿æ•´ */
}
/* ===== ä¸‹éƒ¨ãƒãƒ¼ï¼šæœ€ä¸‹éƒ¨å›ºå®šï¼†1è¡Œã«åã‚ã‚‹ ===== */
.battle-actions{
  position: fixed; left: 0; right: 0; bottom: 0;
  height: 44px;
  padding: 0 10px calc(env(safe-area-inset-bottom));
  background: rgba(0,0,0,.98);
  display: grid;
  grid-template-columns: auto 1fr;   /* [ãƒœã‚¿ãƒ³åˆ—] [ã‚¨ãƒŠã‚¸ãƒ¼+ãƒ­ã‚°] */
  align-items: center; gap: 10px;
  z-index: 50;
}

/* ===== ãƒœã‚¿ãƒ³åˆ—ï¼šä¸€ç›´ç·šã«â€œå˜ç´”ã«ä¸¦ã¹ã‚‹ã ã‘â€ ===== */
.action-buttons{
  display: flex !important;
  align-items: center;
  justify-content: center;           /* ä¸­å¤®å¯„ã›ã€‚å·¦å¯„ã›ã«ã—ãŸã„ãªã‚‰ flex-start */
  gap: 8px;
  width: 100%;
  height: 32px;                      /* è¡Œã®é«˜ã•ï¼ãƒœã‚¿ãƒ³ã®é«˜ã• */
  padding: 0; margin: 0;
  background: transparent !important; border: 0 !important; box-shadow: none !important;
}

/* å„ãƒœã‚¿ãƒ³ã®ãƒªã‚»ãƒƒãƒˆï¼ˆãƒãƒ©ã‘é˜²æ­¢ï¼‰ */
.action-btn{
  position: static !important;       /* æ—¢å­˜ã® absolute/relative ç„¡åŠ¹åŒ– */
  inset: auto !important;
  transform: none !important;
  margin: 0 !important;
  padding: 0 !important;

  height: 100%;                      /* è¦ªã®32pxã«åˆã‚ã›ã‚‹ */
  aspect-ratio: 1/1;                 /* æ­£æ–¹å½¢ã‚’å¼·åˆ¶ */
  width: auto; min-width: 32px;      /* Safariå¯¾ç­– */
  border-radius: 6px;
  display: grid; place-items: center;
  box-sizing: border-box;
}
.action-text{ display: none !important; }
.action-icon{ width: 20px; height: 20px; }
.action-icon img{ width: 100%; height: 100%; object-fit: contain; }

/* ===== å³å´ï¼šã‚¨ãƒŠã‚¸ãƒ¼ï¼‹ãƒ­ã‚°ã‚’åŒã˜è¡Œã«ï¼ˆè½ã¡ãªã„ï¼†è©°ã‚ã‚‹ï¼‰ ===== */
.battle-info{
  display: flex !important;
  align-items: center;
  justify-content: flex-end;
  gap: 8px;
  min-width: 0;                      /* ãƒ­ã‚°ãŒæŠ˜ã‚Šè¿”ã•ãªã„ã‚ˆã†ã« */
}
.energy-bar{
  display: flex; align-items: center; gap: 4px;
  padding: 0; background: transparent !important; border: 0 !important; box-shadow: none !important;
}
.energy-title{ font-size: .6rem; color:#64ffda; }
.energy-orbs{ display: flex; gap: 2px; }
.energy-orb{ width: 8px; height: 8px; border: 1px solid #64ffda; }
.energy-orb.filled{ background:#64ffda; }

.battle-log{
  flex: 1 1 auto; min-height: auto; padding: 0;
  background: transparent !important; border: 0 !important; box-shadow: none !important;
  display: flex; align-items: center; justify-content: flex-end;
}
.log-text{
  font-size: .58rem; color:#a8b2d1;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  max-width: 40vw;                   /* å¿…è¦ã«å¿œã˜ã¦åœ§ç¸®å¹…ã‚’èª¿æ•´ */
}

/* ã‚¨ãƒŠã‚¸ãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ‰ãƒƒãƒˆã‚’ãã£ãã‚Šè¡¨ç¤º */
.energy-bar,
.energy-bar * {
  opacity: 1 !important;
}

.energy-title {
  color: #64ffda !important;   /* æ˜ã‚‹ã„ã‚·ã‚¢ãƒ³ */
  font-weight: 700;
  letter-spacing: .02em;
}

/* ãƒ‰ãƒƒãƒˆï¼ˆã‚ªãƒ¼ãƒ–ï¼‰ã‚‚è¦‹ã‚„ã™ã */
.energy-orb { 
  border: 1px solid #64ffda !important;
}
.energy-orb.filled {
  background: #64ffda !important;
}
.media-overlay.cutin .media-frame { display: none !important; }
.battle-actions, .battle-actions * { opacity: 1 !important; }
.energy-title { color:#64ffda !important; font-weight:700; letter-spacing:.02em; }
.energy-orb { border-color:#64ffda !important; }
.energy-orb.filled { background:#64ffda !important; }
.action-buttons{
  display:flex !important; align-items:center; justify-content:center;
  gap:8px; height:32px; padding:0; margin:0;
}
.action-btn{
  position:static !important; inset:auto !important; transform:none !important;
  width:auto; min-width:32px; height:100%;
  aspect-ratio:1/1;
  padding:0; margin:0; border-radius:6px;
  display:grid; place-items:center; box-sizing:border-box;
}
.action-text{ display:none !important; }
.action-icon{ width:20px; height:20px; }
/* ===== ã‚¨ãƒŠã‚¸ãƒ¼ã¨ãƒ­ã‚°ã‚’å¸¸ã«ãã£ãã‚Šè¡¨ç¤º ===== */
.energy-bar, .energy-bar * {
  color: #64ffda !important;
  opacity: 1 !important;
  font-weight: 700;
}

.battle-log, .battle-log * {
  color: #ffffff !important;
  opacity: 1 !important;
  font-size: 12px;
  font-weight: 600;
}
/* é»’å¸¯ãã®ã‚‚ã®ã¯ã‚¯ãƒªãƒƒã‚¯ä¸å¯ã«ã™ã‚‹ */
.battle-actions {
  pointer-events: none;   /* é»’å¸¯ã¯ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹ */
}

/* ãŸã ã—ãƒœã‚¿ãƒ³ã¯ä¾‹å¤–çš„ã«ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ */
.battle-actions .action-btn,
.battle-actions .action-btn * {
  pointer-events: auto;
}
<!-- ===== FIX: é»’å¸¯ã®ã‚°ãƒ¬ãƒ¼åŒ–ã‚’å®Œå…¨ç„¡åŠ¹åŒ–ï¼ˆã‚¢ã‚¤ã‚³ãƒ³/ã‚¨ãƒŠã‚¸ãƒ¼/ãƒ­ã‚°ï¼‰ ===== -->
<style>
  /* é»’å¸¯é…ä¸‹ã®â€œè–„ãè¦‹ãˆã‚‹â€è¦å› ã‚’ä¸€æ‹¬ã§ç„¡åŠ¹åŒ– */
  .battle-actions, .battle-actions * {
    opacity: 1 !important;
    filter: none !important;
    mix-blend-mode: normal !important;
  }
  /* ãƒœã‚¿ãƒ³ã«ä¹—ã£ã¦ã‚‹è–„ã„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’æ’¤å» */
  .battle-actions .action-btn::before {
    background: transparent !important;
  }
  /* ã‚¢ã‚¤ã‚³ãƒ³ç®±ã®åŠé€æ˜ã‚’æ’¤å»ï¼†æ è‰²ã‚’ã¯ã£ãã‚Š */
  .battle-actions .action-icon {
    background: transparent !important;
    border: 1px solid #64ffda !important;
  }
  .battle-actions .action-icon img {
    opacity: 1 !important;
    filter: none !important;
  }
  /* ã‚¨ãƒŠã‚¸ãƒ¼ï¼†ãƒ­ã‚°ã‚’æ˜è‰²ã§å›ºå®š */
  #energyOrbs .energy-orb { border-color:#64ffda !important; }
  #energyOrbs .energy-orb.filled { background:#64ffda !important; }
  .battle-actions .battle-log, .battle-actions .battle-log * { color:#fff !important; }

  


</style>


</head>
<body>
<div id="loadingScreen" style="position:fixed;inset:0;background:#000;color:#64ffda;display:flex;align-items:center;justify-content:center;z-index:9999">
  <span>Loading...</span>
</div>

  <div class="battle-container">
    <div class="battle-header">
      <div class="turn-info" id="turnInfo">ã‚¿ãƒ¼ãƒ³ 1 - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚§ãƒ¼ã‚º (Lv.1)</div>
      <div class="battle-controls">
        <button class="control-btn" onclick="toggleCharacterSelect()">ã‚­ãƒ£ãƒ©å¤‰æ›´</button>
        <button class="control-btn" onclick="resetBattle()">ãƒªãƒ­ãƒ¼ãƒ‰</button>
        <button class="control-btn" onclick="surrender()">é™å‚</button>
        <!-- ã‚¢ãƒ«ãƒãƒ ï¼ˆã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã§è§£æ”¾ï¼ãƒ‡ãƒãƒƒã‚°æ™‚ã¯å¸¸æ™‚ONï¼‰ -->
        <button class="control-btn" id="albumBtn" onclick="toggleAlbum()" disabled title="ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°åˆ°é”ã§è§£æ”¾">ã‚¢ãƒ«ãƒãƒ </button>
      </div>
    </div>

    <!-- ä¸­å¤®æ¼”å‡ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="media-overlay" id="mediaOverlay"></div>

    <div class="battlefield">
      <div class="enemy-side">
        <div class="character-name">ã‚·ãƒ£ãƒ‰ã‚¦ãƒ»ã‚­ãƒ£ãƒƒãƒˆ</div>
        <div class="enemy-meta">
          <div class="enemy-level" id="enemyLevel">Lv.1</div>
          <div class="enemy-atk" id="enemyAtk">ATKå€ç‡ x1.0</div>
        </div>
        <div class="character-sprite shadow" id="enemySprite">ğŸ±</div>
        <div class="hp-bar-container">
          <div class="hp-bar"><div class="hp-fill" id="enemyHpBar" style="width:100%"></div></div>
          <div class="hp-text" id="enemyHpText">2000 / 2000</div>
        </div>
      </div>

      <div class="player-side">
        <div class="character-name" id="playerCharacterName">ãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒãƒˆ <span id="buffEmoji">â—»ï¸â—»ï¸â—»ï¸</span></div>
        <div class="character-sprite prism" id="playerSprite">ğŸ±</div>
        <div class="hp-bar-container">
          <div class="hp-bar"><div class="hp-fill" id="playerHpBar" style="width:100%"></div></div>
          <div class="hp-text" id="playerHpText">1000 / 1000</div>
        </div>
      </div>
    </div>

    <div class="battle-actions">
      <div class="action-buttons">
        <button class="action-btn" id="attackBtn" onclick="handleAction('attack')" aria-label="æ”»æ’ƒ" title="æ”»æ’ƒ">
          <div class="action-icon" id="attackIcon">âš”ï¸</div>
          <div class="action-text"><div class="action-title">æ”»æ’ƒ</div><div class="action-cost">ã‚³ã‚¹ãƒˆ: 2</div></div>
        </button>

        <button class="action-btn" id="skillBtn" onclick="handleAction('skill')" aria-label="ã‚¹ã‚­ãƒ«" title="ã‚¹ã‚­ãƒ«">
          <div class="action-icon" id="skillIcon">âœ¨</div>
          <div class="action-text"><div class="action-title">ã‚¹ã‚­ãƒ«</div><div class="action-cost">ã‚³ã‚¹ãƒˆ: 4</div></div>
        </button>

        <button class="action-btn" id="guardBtn" onclick="handleAction('guard')" aria-label="é˜²å¾¡" title="é˜²å¾¡">
          <div class="action-icon" id="guardIcon">ğŸ›¡ï¸</div>
          <div class="action-text"><div class="action-title">é˜²å¾¡</div><div class="action-cost">ã‚³ã‚¹ãƒˆ: 0</div></div>
        </button>

        <button class="action-btn" id="dodgeBtn" onclick="handleAction('dodge')" aria-label="å›é¿" title="å›é¿">
          <div class="action-icon" id="dodgeIcon">ğŸ’¨</div>
          <div class="action-text"><div class="action-title">å›é¿</div><div class="action-cost">ã‚³ã‚¹ãƒˆ: 2</div></div>
        </button>

        <button class="action-btn" id="specialSkillBtn" onclick="handleAction('specialSkill')" aria-label="ç‰¹æ®Šã‚¹ã‚­ãƒ«" title="ç‰¹æ®Šã‚¹ã‚­ãƒ«">
          <div class="action-icon" id="specialSkillIcon">â­</div>
          <div class="action-text"><div class="action-title">ç‰¹æ®Šã‚¹ã‚­ãƒ«</div><div class="action-cost">ã‚³ã‚¹ãƒˆ: 5</div></div>
        </button>

        <button class="action-btn" id="specialBtn" onclick="handleAction('special')" aria-label="å¿…æ®ºæŠ€" title="å¿…æ®ºæŠ€">
          <div class="action-icon" id="specialIcon">ğŸ’¥</div>
          <div class="action-text"><div class="action-title" id="specialTitle">å¿…æ®ºæŠ€</div><div class="action-cost">ã‚³ã‚¹ãƒˆ: 6</div></div>
        </button>
      </div>

      <div class="battle-info">
        <div class="energy-bar">
          <div class="energy-title">ã‚¨ãƒŠã‚¸ãƒ¼</div>
          <div class="energy-orbs" id="energyOrbs">
            <div class="energy-orb filled"></div><div class="energy-orb filled"></div><div class="energy-orb filled"></div>
            <div class="energy-orb filled"></div><div class="energy-orb filled"></div><div class="energy-orb filled"></div>
            <div class="energy-orb"></div><div class="energy-orb"></div><div class="energy-orb"></div><div class="energy-orb"></div>
          </div>
        </div>
        <div class="battle-log"><div class="log-text" id="battleLog">æˆ¦é—˜é–‹å§‹ï¼è¡Œå‹•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div></div>
      </div>
    </div>
  </div>

  <!-- ã‚¢ãƒ«ãƒãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="album-modal" id="albumModal">
    <div class="album-header">ã‚¢ãƒ«ãƒãƒ  <button class="album-close" onclick="toggleAlbum()">é–‰ã˜ã‚‹</button></div>
    <div class="album-grid" id="albumGrid"></div>
  </div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" onclick="if(event.target===this) closeLightbox()">
    <div class="lightbox-content">
      <button class="lightbox-close" onclick="closeLightbox()" aria-label="é–‰ã˜ã‚‹">âœ•</button>
      <div id="lightboxMedia"></div>
      <div class="lightbox-caption" id="lightboxCaption"></div>
    </div>
  </div>

  <!-- å·¦ï¼šã‚­ãƒ£ãƒ©é¸æŠ -->
  <div class="character-select-panel" id="characterSelectPanel" style="display:none;position:fixed;top:70px;left:20px;width:300px;background:rgba(0,0,0,.95);padding:15px;border-radius:10px;border:2px solid #64ffda;z-index:2001;max-height:calc(100vh - 100px);overflow:auto">
    <h3 style="color:#64ffda;margin-bottom:15px">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ</h3>
    <div class="character-option" onclick="selectCharacter('fire', true)" style="display:flex;align-items:center;gap:15px;padding:10px;margin-bottom:10px;background:rgba(100,255,218,.1);border:1px solid rgba(100,255,218,.3);border-radius:8px;cursor:pointer">
      <div class="character-preview fire" style="width:60px;height:60px;border-radius:10px;border:2px solid #64ffda;display:flex;align-items:center;justify-content:center;font-size:2rem">ğŸ”¥</div>
      <div class="character-info"><div class="character-name-select" style="color:#64ffda;font-weight:bold;margin-bottom:5px">ãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒãƒˆ</div><div class="character-desc" style="color:#a8b2d1;font-size:.8rem">ç«ç‚ç³»</div></div>
    </div>
    <div class="character-option" onclick="selectCharacter('prism', true)" style="display:flex;align-items:center;gap:15px;padding:10px;margin-bottom:10px;background:rgba(100,255,218,.1);border:1px solid rgba(100,255,218,.3);border-radius:8px;cursor:pointer">
      <div class="character-preview prism" style="width:60px;height:60px;border-radius:10px;border:2px solid #64ffda;display:flex;align-items:center;justify-content:center;font-size:2rem">ğŸ’</div>
      <div class="character-info"><div class="character-name-select" style="color:#64ffda;font-weight:bold;margin-bottom:5px">ãƒ—ãƒªã‚ºãƒ ã‚­ãƒ£ãƒƒãƒˆ</div><div class="character-desc" style="color:#a8b2d1;font-size:.8rem">å…‰å±æ€§</div></div>
    </div>
    <div class="character-option" onclick="selectCharacter('shadow', true)" style="display:flex;align-items:center;gap:15px;padding:10px;margin-bottom:10px;background:rgba(100,255,218,.1);border:1px solid rgba(100,255,218,.3);border-radius:8px;cursor:pointer">
      <div class="character-preview shadow" style="width:60px;height:60px;border-radius:10px;border:2px solid #64ffda;display:flex;align-items:center;justify-content:center;font-size:2rem">ğŸŒ™</div>
      <div class="character-info"><div class="character-name-select" style="color:#64ffda;font-weight:bold;margin-bottom:5px">ã‚·ãƒ£ãƒ‰ã‚¦ã‚­ãƒ£ãƒƒãƒˆ</div><div class="character-desc" style="color:#a8b2d1;font-size:.8rem">é—‡å±æ€§</div></div>
    </div>
    <div style="margin-top:12px;text-align:center"><button class="control-btn" onclick="toggleCharacterSelect()" style="border-radius:8px">é–‰ã˜ã‚‹</button></div>
  </div>
<script>
  // ===== ç”»åƒãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ =====
function preloadImages(sources, callback){
  let loaded = 0;
  if(sources.length===0){ callback(); return; }
  sources.forEach(src=>{
    const img=new Image();
    img.onload=img.onerror=()=>{
      loaded++;
      if(loaded===sources.length) callback();
    };
    img.src=src;
  });
}

// ===== ç”»åƒãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ =====
const ASSET = './assets';
const P = {
  fire:   `${ASSET}/fire-cat`,
  prism:  `${ASSET}/prism-cat`,
  shadow: `${ASSET}/shadow-cat`,
  ui:     `${ASSET}/ui`
};

// === æ¼”å‡ºæ™‚é–“ ===
const VICTORY_GIF_MS = 5000;
const VICTORY_MARGIN_MS = 800;
const VICTORY_TOTAL_WAIT = VICTORY_GIF_MS + VICTORY_MARGIN_MS;

// ãƒ‡ãƒãƒƒã‚°ï¼šã‚¢ãƒ«ãƒãƒ ã‚’å¸¸æ™‚ONï¼ˆå…¬é–‹æ™‚ã¯ falseï¼‰
const DEBUG_FORCE_ALBUM = false;

// ===== ãƒ¡ãƒ‡ã‚£ã‚¢åˆæœŸå€¤ï¼ˆãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼ã§é–‹å§‹ï¼‰ =====
var mediaDefaults = {
  // UIãƒ•ãƒ¬ãƒ¼ãƒ  & ãƒœã‚¿ãƒ³ã‚¢ã‚¤ã‚³ãƒ³
  iconFrameBlue:{src:`${P.ui}/icon-frame-blue.png`},
  iconFrameRed:{src:`${P.ui}/icon-frame-red.png`},
  attackIcon:{src:`${P.ui}/attack-icon.png`},
  skillIcon:{src:`${P.ui}/skill-icon.png`},
  guardIcon:{src:`${P.ui}/guard-icon.png`},
  dodgeIcon:{src:`${P.ui}/dodge-icon.png`},
  specialSkillIcon:{src:`${P.ui}/special-skill-icon.png`},
  specialIcon:{src:`${P.ui}/special-icon.png`},

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼/æ•µ
  icon:{src:`${P.fire}/icon.webp`},
  enemyIcon:{src:`${ASSET}/enemy-shadowcat.webp`},

  // æ¼”å‡ºï¼ˆâ˜…special-skill ã‚’æ˜ç¤ºï¼‰
  attack:{src:`${P.fire}/attack.webp`},
  skill:{src:`${P.fire}/skill.webp`},
  guard:{src:`${P.fire}/guard.webp`},
  specialSkill:{src:`${P.fire}/special-skill.webp`},
  special:{src:`${P.fire}/special.webp`},
  awakening:{src:`${P.fire}/awakening.webp`},
  cutIn:{src:`${P.fire}/cutin.webp`},
  dodge:{src:`${P.fire}/dodge.webp`},
  damage:{src:`${P.fire}/damage.webp`},
  victory:{src:`${P.fire}/victory.gif`},
  defeat:{src:`${P.fire}/defeat.webp`},
  uiBackground:{src:`${P.fire}/bg.webp`},
  commandBackground:{src:`${P.ui}/cmd-bg.webp`},
  ending:{src:`${ASSET}/ending.webp`}
};

// ===== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ =====
var game = {
  level:1,
  levelData:{1:{hp:2000,atk:1.0},2:{hp:2500,atk:1.1},3:{hp:3000,atk:1.2},4:{hp:3500,atk:1.3},5:{hp:4000,atk:1.4}},
  enemyHp:2000,enemyMaxHp:2000,enemyAtkMul:1.0,
  energy:6,turn:1,currentCharacter:'fire',
  gameEnded:false,mediaPlaying:false,
  guardActive:false,dodgePenalty:false,
  overlayLock:false,overlayRunId:0,overlayCloseTimer:null,overlayForceTimer:null,
  albumUnlocked:false,
  teamBuff:{fire:false,prism:false,shadow:false},
  characters:{
    fire:{name:'ãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒãƒˆ',basePath:P.fire,hp:1000,maxHp:1000,specialActive:false,defeated:false},
    prism:{name:'ãƒ—ãƒªã‚ºãƒ ã‚­ãƒ£ãƒƒãƒˆ',  basePath:P.prism,hp:1000,maxHp:1000,specialActive:false,defeated:false},
    shadow:{name:'ã‚·ãƒ£ãƒ‰ã‚¦ã‚­ãƒ£ãƒƒãƒˆ',  basePath:P.shadow,hp:1000,maxHp:1000,specialActive:false,defeated:false}
  },
  media:{},playerHp:1000
};

// ===== åˆæœŸåŒ– =====
document.addEventListener('DOMContentLoaded', ()=>{
  const sources = Object.values(mediaDefaults).map(v=>v.src);
  const start = Date.now();
  const MIN_LOADING_MS = 1200;
  preloadImages(sources, ()=>{
    const elapsed = Date.now() - start;
    const remain = Math.max(0, MIN_LOADING_MS - elapsed);
    setTimeout(()=>{
      document.getElementById('loadingScreen').style.display='none';
      initializeGame();
    }, remain);
  });
});  // â˜… â† ã“ã‚ŒãŒæŠœã‘ã¦ã„ãŸ

window.addEventListener('load', ()=>setTimeout(enableActionButtons,100));

function initializeGame(){
  for(const k in mediaDefaults){
    const v=mediaDefaults[k];
    game.media[k]={src:v.src,isVideo:/\.(mp4|webm|ogg|mov|avi)$/i.test(v.src)};
  }
  setEnemyLevel(game.level);
  document.getElementById('playerCharacterName').childNodes[0].nodeValue = game.characters[game.currentCharacter].name + ' ';
  updatePlayerIcon(); updateEnemyIcon();
  updateActionIcons(); updateUIBackground(); updateCommandBackground(); updateCharacterSelectIcons();
  updateHP(); updateEnemyMetaUI(); updateBuffEmoji(); updateAlbumButton();
  updateCharacterDefeatedStyles();

  // é–‹å§‹æ™‚ +3
  game.energy=Math.min(10,game.energy+3);
  updateEnergy();
  updateLog('æˆ¦é—˜é–‹å§‹ï¼ã‚¨ãƒŠã‚¸ãƒ¼+3ã€‚è¡Œå‹•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
}

/* ---------- ãƒ¬ãƒ™ãƒ«/ãƒ¡ã‚¿ ---------- */
function setEnemyLevel(level){
  const d=game.levelData[level];
  game.level=level; game.enemyMaxHp=d.hp; game.enemyHp=d.hp; game.enemyAtkMul=d.atk;
  document.getElementById('turnInfo').textContent=`ã‚¿ãƒ¼ãƒ³ ${game.turn} - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚§ãƒ¼ã‚º (Lv.${game.level})`;
  updateEnemyMetaUI(); updateHP();
}
function updateEnemyMetaUI(){
  enemyLevel.textContent='Lv.'+game.level;
  enemyAtk.textContent='ATKå€ç‡ x'+game.enemyAtkMul.toFixed(1);
}

/* ---------- UIæ›´æ–° ---------- */
function updateUIBackground(){
  if(game.media.uiBackground){
    document.body.style.backgroundImage=`url("${game.media.uiBackground.src}"), linear-gradient(135deg,#0a0e27 0%,#1a1a2e 50%,#16213e 100%)`;
  }
}
function updateCommandBackground(){
  if(!game.media.commandBackground) return;
  document.querySelectorAll('.action-btn').forEach(b=>{
    b.style.backgroundImage=`url("${game.media.commandBackground.src}"), linear-gradient(135deg,#667eea,#764ba2)`;
  });
}
function updateActionIcons(){
  const setIcon=(id,src,fallback)=>{
    const el=document.getElementById(id); if(!el) return;
    if(src){ el.innerHTML = `<img src="${src}" alt="" onerror="this.onerror=null;this.parentElement.textContent='${fallback}'">`; }
    else{ el.textContent = fallback; }
  };
  setIcon('attackIcon',        game.media.attackIcon?.src,        'âš”ï¸');
  setIcon('skillIcon',         game.media.skillIcon?.src,         'âœ¨');
  setIcon('guardIcon',         game.media.guardIcon?.src,         'ğŸ›¡ï¸');
  setIcon('dodgeIcon',         game.media.dodgeIcon?.src,         'ğŸ’¨');
  setIcon('specialSkillIcon',  game.media.specialSkillIcon?.src,  'â­');
  setIcon('specialIcon',       game.media.specialIcon?.src,       'ğŸ’¥');
}
function updateCharacterSelectIcons(){
  const pref=(base)=>`${base}/change.webp`;
  const fallback=(base)=>`${base}/icon.webp`;
  [['.character-preview.fire',P.fire],['.character-preview.prism',P.prism],['.character-preview.shadow',P.shadow]]
    .forEach(([sel,base])=>{
      const el=document.querySelector(sel); if(!el) return;
      el.innerHTML=`<img src="${pref(base)}" onerror="this.onerror=null;this.src='${fallback(base)}'" style="width:100%;height:100%;object-fit:cover;border-radius:8px">`;
    });
}
function updateCharacterDefeatedStyles(){
  [
    {key:'fire',   selector: ".character-option[onclick*=\"'fire'\"]"},
    {key:'prism',  selector: ".character-option[onclick*=\"'prism'\"]"},
    {key:'shadow', selector: ".character-option[onclick*=\"'shadow'\"]"}
  ].forEach(({key, selector})=>{
    const node = document.querySelector(selector);
    if(!node) return;
    if (game.characters[key].defeated) node.classList.add('is-defeated');
    else node.classList.remove('is-defeated');
  });
}
function updatePlayerIcon(){
  const s=document.getElementById('playerSprite'), m=game.media.icon;
  s.innerHTML = m ? `<img src="${m.src}" style="width:100%;height:100%;object-fit:cover;border-radius:15px">` : 'ğŸ±';
  if(game.media.iconFrameBlue){const f=document.createElement('img');f.src=game.media.iconFrameBlue.src;f.className='icon-frame';f.style.objectFit='cover';f.style.borderRadius='15px';s.appendChild(f);}
}
function updateEnemyIcon(){
  const s=document.getElementById('enemySprite'), m=game.media.enemyIcon;
  s.innerHTML = m ? `<img src="${m.src}" style="width:100%;height:100%;object-fit:cover;border-radius:15px">` : 'ğŸ±';
  if(game.media.iconFrameRed){const f=document.createElement('img');f.src=game.media.iconFrameRed.src;f.className='icon-frame';f.style.objectFit='cover';f.style.borderRadius='15px';s.appendChild(f);}
}
function updateHP(){
  const ch=game.characters[game.currentCharacter];
  const pPct=Math.max(0,(game.playerHp??ch.hp)/ch.maxHp)*100;
  const ePct=Math.max(0,game.enemyHp/game.enemyMaxHp)*100;
  playerHpBar.style.width=pPct+'%'; enemyHpBar.style.width=ePct+'%';
  colorBar(playerHpBar,pct=pPct); colorBar(enemyHpBar,pct=ePct);
  playerHpText.textContent=(game.playerHp??ch.hp)+' / '+ch.maxHp;
  enemyHpText.textContent=game.enemyHp+' / '+game.enemyMaxHp;
  updateSpecialAttack();
}
function colorBar(el,pct){ el.classList.remove('yellow','red'); if(pct<=25) el.classList.add('red'); else if(pct<=50) el.classList.add('yellow'); }
function updateSpecialAttack(){
  const ch=game.characters[game.currentCharacter];
  const pPct=((game.playerHp??ch.hp)/ch.maxHp)*100;
  const t=document.getElementById('specialTitle');
  t.textContent = (pPct<=25) ? 'è¦šé†’æŠ€' : 'å¿…æ®ºæŠ€';
}

/* ---------- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼†ã‚¿ã‚¤ãƒãƒ¼ ---------- */
function positionOverlayCenter(overlay,w,h){
  const r=document.querySelector('.battlefield').getBoundingClientRect();
  overlay.style.position='fixed'; overlay.style.left=(r.left+r.width/2)+'px'; overlay.style.top=(r.top+r.height/2)+'px';
  overlay.style.transform='translate(-50%,-50%)'; overlay.style.width=w; overlay.style.height=h;
}
function cancelOverlayTimers(){
  if(game.overlayCloseTimer){clearTimeout(game.overlayCloseTimer);game.overlayCloseTimer=null;}
  if(game.overlayForceTimer){clearTimeout(game.overlayForceTimer);game.overlayForceTimer=null;}
}
/* ---------- è¡Œå‹• ---------- */
function handleAction(action){
  if (game.gameEnded || game.mediaPlaying) return;

  const ch = game.characters[game.currentCharacter];
  const curHp = game.playerHp ?? ch.hp;

  if (curHp <= 0 || ch.defeated){
    updateLog('ã“ã®ã‚­ãƒ£ãƒ©ã¯æˆ¦é—˜ä¸èƒ½ã§ã™ã€‚äº¤ä»£ã—ã¦ãã ã•ã„ã€‚');
    const next = Object.keys(game.characters).find(k => !game.characters[k].defeated);
    if (next) selectCharacter(next, false, true);
    return;
  }
  useAction(action);
}

function useAction(type){
  const cost = {attack:2, skill:4, guard:0, dodge:2, specialSkill:5, special:6}[type];
  if (game.energy < cost){ updateLog('ã‚¨ãƒŠã‚¸ãƒ¼ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼'); return; }
  game.energy -= cost; updateEnergy();

  const ch = game.characters[game.currentCharacter];
  const pPct = ((game.playerHp ?? ch.hp) / ch.maxHp) * 100;
  let damage = 0, mediaTime = 1500, delayTime = mediaTime;

  switch(type){
    case 'attack': {
      damage = Math.floor(Math.random()*150)+100;
      if (game.teamBuff.fire) damage *= 2;
      if (game.teamBuff.shadow && Math.random() < 0.25) damage *= 3;
      updateLog(`æ”»æ’ƒï¼${damage}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
      showActionMedia('attack', mediaTime);
      break;
    }
    case 'skill': {
      damage = Math.floor(Math.random()*200)+150;
      if (game.teamBuff.fire) damage *= 2;
      if (game.teamBuff.shadow && Math.random() < 0.25) damage *= 3;
      updateLog(`ã‚¹ã‚­ãƒ«ï¼${damage}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
      showActionMedia('skill', mediaTime);
      break;
    }
    case 'guard':
      game.guardActive = true;
      updateLog('é˜²å¾¡ï¼æ¬¡ã®è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸30%è»½æ¸›ï¼ˆ1å›ã®ã¿ï¼‰');
      showActionMedia('guard', mediaTime);
      break;

    case 'dodge': {
      showActionMedia('dodge', mediaTime);
      const success = Math.random() < 0.7;
      if (success){
        updateLog('å›é¿æˆåŠŸï¼ã‚¨ãƒŠã‚¸ãƒ¼å…¨å›å¾©ã€‚ã“ã®ã‚¿ãƒ¼ãƒ³ã®æ•µæ”»æ’ƒã¯ã‚¹ã‚­ãƒƒãƒ—ï¼');
        game.energy = 10; updateEnergy();
        setTimeout(nextTurn, mediaTime+300);
        return;
      } else {
        updateLog('å›é¿å¤±æ•—â€¦ã“ã®ã‚¿ãƒ¼ãƒ³ã®è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸1.2å€ï¼');
        game.dodgePenalty = true;
        setTimeout(()=>{ if(!game.gameEnded) enemyAttack(); }, mediaTime+300);
        return;
      }
    }

    case 'specialSkill': {
      ch.specialActive = true;
      game.teamBuff[game.currentCharacter] = true;
      showActionMedia('specialSkill', mediaTime);

      if (game.currentCharacter==='fire')   updateLog('ç‰¹æ®Šã‚¹ã‚­ãƒ«ï¼å…¨å“¡ã«ãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼ãƒãƒ•ï¼ˆä¸ãƒ€ãƒ¡2å€ï¼‰');
      if (game.currentCharacter==='shadow') updateLog('ç‰¹æ®Šã‚¹ã‚­ãƒ«ï¼å…¨å“¡ã«ã‚·ãƒ£ãƒ‰ã‚¦ãƒãƒ•ï¼ˆ25%ã§ä¸ãƒ€ãƒ¡3å€ï¼‰');
      if (game.currentCharacter==='prism')  updateLog('ç‰¹æ®Šã‚¹ã‚­ãƒ«ï¼å…¨å“¡ã«ãƒ—ãƒªã‚ºãƒ ãƒãƒ•ï¼ˆ25%ã§è¢«ãƒ€ãƒ¡ç„¡åŠ¹ï¼‰');

      updateBuffEmoji();

      // åŒã‚¿ãƒ¼ãƒ³ã§å¿…ãšæ•µè¡Œå‹•ã¸ï¼ˆã‚¹ã‚­ãƒƒãƒ—ã•ã›ãªã„ï¼‰
      setTimeout(()=>{ if(!game.gameEnded) enemyAttack(); }, mediaTime+300);
      return;
    }

    case 'special': {
      damage = (pPct <= 25)
        ? Math.floor(Math.random()*400)+350
        : Math.floor(Math.random()*300)+250;
      if (game.teamBuff.fire) damage *= 2;
      if (game.teamBuff.shadow && Math.random() < 0.25) damage *= 3;

      if (pPct <= 25){
        updateLog(`è¦šé†’æŠ€ï¼${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
        showCutInAndAwakening(1500,1500);
        document.getElementById('mediaOverlay').classList.add('cutin');
        delayTime = 3000;
      } else {
        updateLog(`å¿…æ®ºæŠ€ï¼${damage}ã®å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
        showActionMedia('special', mediaTime);
      }
      break;
    }
  }

  if (damage > 0){
    game.enemyHp = Math.max(0, game.enemyHp - damage);
    updateHP();
    if (game.enemyHp <= 0){ setTimeout(victory, delayTime+500); return; }
  }
  setTimeout(()=>{ if(!game.gameEnded) enemyAttack(); }, delayTime+500);
}

/* ---------- æ•µæ”»æ’ƒ ---------- */
function enemyAttack(){
  let base = Math.floor(Math.random()*201)+120; // 120ã€œ320
  let damage = Math.floor(base * game.enemyAtkMul);

  if (game.dodgePenalty){
    damage = Math.floor(damage * 1.2);
    updateLog(`ï¼ˆå›é¿å¤±æ•—ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼‰ãƒ€ãƒ¡ãƒ¼ã‚¸1.2å€ â†’ ${damage}`);
    game.dodgePenalty = false;
  } else {
    if (game.teamBuff.prism && Math.random()<0.25){
      damage = 0;
      updateLog('æ•µã®æ”»æ’ƒï¼ãƒ—ãƒªã‚ºãƒ ãƒãƒ•ã§ãƒ€ãƒ¡ãƒ¼ã‚¸å®Œå…¨ç„¡åŠ¹ï¼');
    } else {
      updateLog(`æ•µã®æ”»æ’ƒï¼å€ç‡x${game.enemyAtkMul.toFixed(1)} â†’ ${damage}ãƒ€ãƒ¡ãƒ¼ã‚¸`);
    }
  }

  if (game.guardActive){ damage = Math.floor(damage*0.7); game.guardActive=false; updateLog(`é˜²å¾¡ç™ºå‹•ï¼è¢«ãƒ€ãƒ¡30%è»½æ¸› â†’ ${damage}`); }
  damage = Math.max(0, Math.round(damage/10)*10);

  const ch = game.characters[game.currentCharacter];
  let cur = (game.playerHp ?? ch.hp);
  cur = Math.max(0, cur - damage);
  game.playerHp = cur; ch.hp = cur;

  updateHP();
  const t = 1000;
  showMedia('damage', t);

  if (cur <= 0){ setTimeout(defeat, t+500); return; }
  setTimeout(nextTurn, t+500);
}

/* ---------- å‹åˆ©ãƒ»æ•—åŒ—ãƒ»é™å‚ ---------- */
function victory(){
  game.gameEnded = true;
  disableActionButtons();
  updateLog('å‹åˆ©ï¼');
  if (game.media.victory) showMedia('victory', VICTORY_GIF_MS);

  if (game.level < 5){
    setTimeout(function(){
      // å…¨å“¡HPå…¨å›å¾© & ãƒãƒ•è§£é™¤
      for (const k in game.characters){
        const c = game.characters[k];
        c.hp = c.maxHp; c.specialActive=false; c.defeated=false;
      }
      game.teamBuff = {fire:false,prism:false,shadow:false};
      updateBuffEmoji();

      // â˜…ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HPã¯å…ˆã«å¾©å…ƒ
      game.playerHp = game.characters[game.currentCharacter].maxHp;

      // é€²è¡Œ
      game.energy = Math.min(10, game.energy + 3);
      game.turn += 1;
      game.level += 1;

      // æ•µãƒ¬ãƒ™ãƒ«ã‚’åæ˜ 
      setEnemyLevel(game.level);

      // â˜…è¡¨ç¤ºã®ç¢ºå®ŸãªåŒæœŸ
      updateHP();
      updateSpecialAttack();

      game.gameEnded = false;
      enableActionButtons();
      updateCharacterDefeatedStyles();
      updateLog(`ãƒ¬ãƒ™ãƒ«${game.level-1}ã‚¯ãƒªã‚¢ï¼å…¨å›å¾©ï¼†ãƒãƒ•è§£é™¤ã§ Lv.${game.level} ã«çªå…¥ï¼`);
    }, VICTORY_TOTAL_WAIT);
  } else {
    setTimeout(()=>{ showEnding(); }, VICTORY_TOTAL_WAIT);
  }
}

function defeat(){
  const key = game.currentCharacter;
  const ch = game.characters[key];
  ch.hp = 0; ch.defeated = true;

  // UIï¼šæ•—åŒ—ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã«å·®ã—æ›¿ãˆ
  const base = ch.basePath;
  const ps = document.getElementById('playerSprite');
  ps.innerHTML = `<img src="${base}/defeat.webp" style="width:100%;height:100%;object-fit:cover;border-radius:15px">`;

  updateHP();
  updateCharacterDefeatedStyles();
  disableActionButtons();
  if (game.media.defeat) showMedia('defeat', 1200);

  // æ¬¡ã®ç”Ÿå­˜ã‚­ãƒ£ãƒ©ã¸è‡ªå‹•äº¤ä»£
  const next = Object.keys(game.characters).find(k => !game.characters[k].defeated);
  if (next){
    setTimeout(function(){
      selectCharacter(next, false, true);
      enableActionButtons();
      updateLog(game.characters[next].name + 'ãŒæˆ¦é—˜ã«å‚åŠ ï¼');
      setTimeout(nextTurn, 500);
    }, 1600);
    return;
  }

  // å…¨æ»…
  game.gameEnded = true;
  updateLog('å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æˆ¦é—˜ä¸èƒ½â€¦å®Œå…¨æ•—åŒ—â€¦');
  if (game.media.defeat) showMedia('defeat', 1500);
}

function surrender(){
  if(!confirm('æˆ¦é—˜ã‚’è«¦ã‚ã¾ã™ã‹ï¼Ÿ')) return;
  game.gameEnded = true;
  disableActionButtons();
  updateLog('é™å‚ã—ã¾ã—ãŸâ€¦');
  if (game.media.defeat) showMedia('defeat', 1200);
}

/* ---------- ã‚¿ãƒ¼ãƒ³é–‹å§‹ (+3) ---------- */
function nextTurn(){
  game.turn++;
  game.energy = Math.min(10, game.energy + 3);
  updateEnergy();
  updateLog('æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã§ã™');
  document.getElementById('turnInfo').textContent = `ã‚¿ãƒ¼ãƒ³ ${game.turn} (Lv.${game.level})`;
}

/* ---------- ãƒ‘ãƒãƒ«/ã‚­ãƒ£ãƒ©é¸æŠ ---------- */
function toggleCharacterSelect(){
  const p = document.getElementById('characterSelectPanel');
  const show = (p.style.display==='none' || p.style.display==='');
  p.style.display = show ? 'block' : 'none';
  if (show){
    updateCharacterDefeatedStyles();
    p.style.pointerEvents = 'auto';
    p.style.zIndex = 2001;
  }
}

function selectCharacter(type, closePanel=true, force=false){
  if (!force && game.gameEnded) return;

  game.currentCharacter = type;
  const ch = game.characters[type];
  game.playerHp = ch.hp;

  document.getElementById('playerCharacterName').childNodes[0].nodeValue = ch.name + ' ';

  const base = ch.basePath;
  game.media.icon.src           = base + '/icon.webp';
  game.media.attack.src         = base + '/attack.webp';
  game.media.skill.src          = base + '/skill.webp';
  game.media.guard.src          = base + '/guard.webp';
  game.media.specialSkill.src   = base + '/special-skill.webp'; // â† ç‰¹æ®Šã‚¹ã‚­ãƒ«
  game.media.special.src        = base + '/special.webp';       // â† å¿…æ®ºæŠ€
  game.media.awakening.src      = base + '/awakening.webp';
  game.media.cutIn.src          = base + '/cutin.webp';
  game.media.dodge.src          = base + '/dodge.webp';
  game.media.damage.src         = base + '/damage.webp';
  game.media.victory.src        = base + '/victory.gif';
  game.media.defeat.src         = base + '/defeat.webp';
  game.media.uiBackground.src   = base + '/bg.webp';

  updatePlayerIcon();
  updateActionIcons();
  updateSpecialAttack();
  updateUIBackground();
  updateCharacterSelectIcons();
  updateHP();
  updateBuffEmoji();
  updateCharacterDefeatedStyles();

  if (closePanel){
    const p = document.getElementById('characterSelectPanel');
    if (p && p.style.display==='block') p.style.display='none';
  }
  enableActionButtons();
}

/* ---------- ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨ä½“åˆæœŸåŒ–ï¼‰ ---------- */
function resetBattle(){
  // æ¼”å‡ºåœæ­¢ï¼†ç‰‡ä»˜ã‘
  cancelOverlayTimers();
  const overlay = document.getElementById('mediaOverlay');
  overlay.classList.remove('show');
  overlay.innerHTML = '';
  game.overlayLock = false;
  game.mediaPlaying = false;

  // ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
  const cs = document.getElementById('characterSelectPanel'); if(cs) cs.style.display='none';
  const album = document.getElementById('albumModal'); if(album) album.style.display='none';

  // ã‚¹ãƒ†ãƒ¼ãƒˆå®Œå…¨åˆæœŸåŒ–
  game.level = 1; setEnemyLevel(1);
  for (const k in game.characters){
    const c = game.characters[k];
    c.hp = c.maxHp; c.specialActive=false; c.defeated=false;
  }
  game.teamBuff = {fire:false,prism:false,shadow:false};
  game.dodgePenalty = false;
  game.guardActive = false;
  game.currentCharacter = 'fire';
  game.playerHp = game.characters.fire.maxHp;
  game.energy = 6;
  game.turn = 1;
  game.gameEnded = false;

  // UIå†æ§‹ç¯‰
  initializeGame();
  updateCharacterDefeatedStyles();
  updateLog('ãƒªã‚»ãƒƒãƒˆå®Œäº†ï¼ãƒ¬ãƒ™ãƒ«1ã‹ã‚‰å†ã‚¹ã‚¿ãƒ¼ãƒˆï¼');
}

/* ---------- æ¼”å‡ºï¼šã‚«ãƒƒãƒˆã‚¤ãƒ³â†’è¦šé†’ ---------- */
function showCutInAndAwakening(cutInDuration=1200, awakeningDuration=1500){
  game.mediaPlaying = true; disableActionButtons();
  const overlay = document.getElementById('mediaOverlay');
  cancelOverlayTimers();
  const runId = ++game.overlayRunId;
  overlay.classList.remove('show');

  const hasCut = !!(game.media.cutIn && game.media.cutIn.src);
  const hasAwk = !!(game.media.awakening && game.media.awakening.src);

 function closeOverlay(){
  if (game.overlayRunId !== runId) return;
  overlay.classList.remove('show');
  overlay.classList.remove('cutin');   // â†ã“ã‚Œã‚’è¿½åŠ 
  setTimeout(()=>{
    if (game.overlayRunId !== runId) return;
    overlay.innerHTML = '';
    positionOverlayCenter(overlay,'400px','400px');
    game.mediaPlaying = false;
    if (!game.gameEnded) enableActionButtons();
  }, 250);
}

 function showAwakening(){
  if (game.overlayRunId !== runId) return;
  positionOverlayCenter(overlay,'600px','600px');
  // æ ã‚’å…¥ã‚Œãªã„
  const content = hasAwk
    ? `<img src="${game.media.awakening.src}" style="width:100%;height:100%;object-fit:contain">`
    : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2rem">Awakening</div>`;
  overlay.innerHTML = `<div class="media-content">${content}</div>`;
  overlay.classList.add('show');
  game.overlayCloseTimer = setTimeout(()=>{ if(game.overlayRunId===runId) closeOverlay(); }, awakeningDuration);
}

// (B) ã‚«ãƒƒãƒˆã‚¤ãƒ³ï¼šæ ã‚’å·®ã—è¾¼ã¾ãªã„
function showCutIn(){
  if (game.overlayRunId !== runId) return;
  overlay.style.width='100vw'; overlay.style.height='auto';
  overlay.style.left='50%'; overlay.style.top='50%'; overlay.style.transform='translate(-50%,-50%)';
  const content = hasCut
    ? `<img src="${game.media.cutIn.src}" style="width:100vw;max-height:100vh;object-fit:contain">`
    : `<div style="width:100vw;height:60vh;display:flex;align-items:center;justify-content:center;font-size:2rem">Cut-in</div>`;
  overlay.innerHTML = `<div class="media-content">${content}</div>`;
  overlay.classList.add('show');
  game.overlayCloseTimer = setTimeout(()=>{
    if (game.overlayRunId !== runId) return;
    overlay.classList.remove('show');
    setTimeout(()=>{ if (game.overlayRunId===runId) showAwakening(); }, 120);
  }, cutInDuration);
}

  if (hasCut) showCutIn();
  else if (hasAwk) showAwakening();
  else closeOverlay();
}

/* ---------- æ±ç”¨æ¼”å‡º ---------- */
function showMedia(type, duration=1500){
  const m = game.media[type];
  if (!m){ game.mediaPlaying=false; enableActionButtons(); return; }

  game.mediaPlaying = true; disableActionButtons();
  const overlay = document.getElementById('mediaOverlay');
  cancelOverlayTimers();
  const runId = ++game.overlayRunId;

  positionOverlayCenter(overlay,'400px','400px');
  const content = m.isVideo
    ? `<video src="${m.src}" autoplay muted loop style="width:100%;height:100%;object-fit:contain"></video>`
    : `<img src="${m.src}" style="width:100%;height:100%;object-fit:contain">`;
 const frame = game.media.iconFrameBlue ? `<img src="${game.media.iconFrameBlue.src}" class="media-frame">` : '';
 overlay.innerHTML = `<div class="media-content">${content}${frame}</div>`;
  overlay.classList.add('show');

  game.overlayCloseTimer = setTimeout(()=>{
    if (game.overlayRunId !== runId || game.overlayLock) return;
    overlay.classList.remove('show');
    setTimeout(()=>{
      if (game.overlayRunId !== runId || game.overlayLock) return;
      overlay.innerHTML = '';
      game.mediaPlaying = false;
      if (!game.gameEnded) enableActionButtons();
    }, 220);
  }, duration);

  // ä¿é™ºï¼šè¡¨ç¤ºæ™‚é–“ãƒ–ãƒ¬å¯¾ç­–
  game.overlayForceTimer = setTimeout(()=>{
    if (game.overlayRunId !== runId || game.overlayLock) return;
    if (game.mediaPlaying){
      overlay.classList.remove('show'); overlay.innerHTML=''; game.mediaPlaying=false;
      if (!game.gameEnded) enableActionButtons();
    }
  }, duration+2000);
}

function showMediaSrc(src, duration=1500){
  if (!src){ game.mediaPlaying=false; enableActionButtons(); return; }
  game.mediaPlaying = true; disableActionButtons();
  const overlay = document.getElementById('mediaOverlay');
  cancelOverlayTimers();
  const runId = ++game.overlayRunId;

  positionOverlayCenter(overlay,'400px','400px');
  const isVideo = /\.(mp4|webm|ogg|mov|avi)$/i.test(src);
  const content = isVideo
    ? `<video src="${src}" autoplay muted loop style="width:100%;height:100%;object-fit:contain"></video>`
    : `<img src="${src}" style="width:100%;height:100%;object-fit:contain">`;
  const frame = game.media.iconFrameBlue ? `<img src="${game.media.iconFrameBlue.src}" class="media-frame" style="object-fit:contain">` : '';
  overlay.innerHTML = `<div class="media-content">${content}${frame}</div>`;
  overlay.classList.add('show');

  game.overlayCloseTimer = setTimeout(()=>{
    if (game.overlayRunId !== runId || game.overlayLock) return;
    overlay.classList.remove('show');
    setTimeout(()=>{
      if (game.overlayRunId !== runId || game.overlayLock) return;
      overlay.innerHTML=''; game.mediaPlaying=false;
      if(!game.gameEnded) enableActionButtons();
    }, 220);
  }, duration);

  game.overlayForceTimer = setTimeout(()=>{
    if (game.overlayRunId !== runId || game.overlayLock) return;
    if (game.mediaPlaying){
      overlay.classList.remove('show'); overlay.innerHTML=''; game.mediaPlaying=false;
      if(!game.gameEnded) enableActionButtons();
    }
  }, duration+2000);
}

/* ---------- ç‰¹æ®Šã‚¹ã‚­ãƒ«ã¯ special-skill ã‚’æœ€å„ªå…ˆ ---------- */
function showActionMedia(type, duration=1500){
  const m = game.media[type];
  if (m && m.src){ showMedia(type, duration); return; }

  let fb = null;
  if (type === 'specialSkill'){
    fb = game.media.specialSkill?.src
      || game.media.icon?.src
      || game.media.specialSkillIcon?.src;
  } else {
    fb = {
      attack:  game.media.attackIcon?.src,
      skill:   game.media.skillIcon?.src,
      guard:   game.media.guardIcon?.src,
      dodge:   game.media.dodgeIcon?.src,
      special: game.media.specialIcon?.src
    }[type] || null;
  }
  showMediaSrc(fb, duration);
}

/* ---------- ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆæ°¸ç¶šï¼‰ï¼†ã‚¢ãƒ«ãƒãƒ è§£æ”¾ ---------- */
function showEnding(){
  const overlay = document.getElementById('mediaOverlay');
  game.overlayLock = true; // æ°¸ç¶šè¡¨ç¤º
  positionOverlayCenter(overlay,'520px','520px');
  const imgHtml = (game.media.ending && game.media.ending.src)
    ? `<img src="${game.media.ending.src}" style="width:100%;height:100%;object-fit:contain">`
    : `<div style="width:100%;height:100%;background:#000"></div>`;
  const frame = game.media.iconFrameBlue ? `<img src="${game.media.iconFrameBlue.src}" class="media-frame" style="object-fit:contain">` : '';
  overlay.innerHTML = `<div class="media-content">${imgHtml}${frame}</div>`;
  overlay.classList.add('show');
  game.gameEnded = true;
  disableActionButtons();
  unlockAlbum();
}

/* ---------- ã‚¢ãƒ«ãƒãƒ  ---------- */
function unlockAlbum(){ if(!game.albumUnlocked){ game.albumUnlocked=true; updateAlbumButton(); updateLog('ã‚¢ãƒ«ãƒãƒ ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼'); } }
function updateAlbumButton(){
  const btn = document.getElementById('albumBtn');
  const unlocked = game.albumUnlocked;  // â† ã‚¯ãƒªã‚¢å¾Œã«unlockAlbum()ã§trueã«ãªã‚‹
  btn.disabled = !unlocked;
  btn.title = unlocked ? 'ã‚­ãƒ£ãƒ©ç”»åƒã‚¢ãƒ«ãƒãƒ ã‚’é–‹ã' : 'ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°åˆ°é”ã§è§£æ”¾';
}
function toggleAlbum(){
  const modal = document.getElementById('albumModal');
  const show = (modal.style.display!=='block');
  modal.style.display = show ? 'block' : 'none';
  if (show) buildAlbumGrid();
}
function buildAlbumGrid(){
  const grid = document.getElementById('albumGrid');
  grid.innerHTML = '';
  const order = ['fire','prism','shadow'];
  order.forEach(key=>{
    const c = game.characters[key];
    const base = c.basePath;

    const sec = document.createElement('div');
    sec.className='album-section';
    sec.textContent = c.name;
    grid.appendChild(sec);

    const items = [
      {label:'ã‚¢ã‚¤ã‚³ãƒ³',     src: base+'/icon.webp'},
      {label:'ãƒã‚§ãƒ³ã‚¸',     src: base+'/change.webp'},
      {label:'ã‚«ãƒƒãƒˆã‚¤ãƒ³',   src: base+'/cutin.webp'},
      {label:'æ”»æ’ƒ',         src: base+'/attack.webp'},
      {label:'ã‚¹ã‚­ãƒ«',       src: base+'/skill.webp'},
      {label:'é˜²å¾¡',         src: base+'/guard.webp'},
      {label:'å›é¿',         src: base+'/dodge.webp'},
      {label:'ç‰¹æ®Šã‚¹ã‚­ãƒ«',   src: base+'/special-skill.webp'},
      {label:'å¿…æ®ºæŠ€',       src: base+'/special.webp'},
      {label:'è¦šé†’æŠ€',       src: base+'/awakening.webp'},
      {label:'ãƒ€ãƒ¡ãƒ¼ã‚¸',     src: base+'/damage.webp'},
      {label:'å‹åˆ©',         src: base+'/victory.gif'},
      {label:'æ•—åŒ—',         src: base+'/defeat.webp'},
      {label:'èƒŒæ™¯',         src: base+'/bg.webp'}
    ];

    items.forEach(it=>{
      const card = document.createElement('div'); card.className='album-card';
      const thumb = document.createElement('div'); thumb.className='album-thumb';

      if (/\.(gif|png|jpg|jpeg|webp)$/i.test(it.src)){
        thumb.innerHTML = `<img loading="lazy" src="${it.src}" alt="${it.label}">`;
        thumb.style.cursor = 'zoom-in';
        thumb.onclick = ()=>openLightbox(it.src, `${c.name}ï¼š${it.label}`);
      } else if (/\.(mp4|webm|ogg|mov|avi)$/i.test(it.src)){
        thumb.innerHTML = `<video src="${it.src}" muted style="background:#000"></video>`;
        thumb.style.cursor = 'zoom-in';
        thumb.onclick = ()=>openLightbox(it.src, `${c.name}ï¼š${it.label}`);
      } else {
        thumb.textContent = 'N/A';
      }

      const cap = document.createElement('div'); cap.className='album-caption'; cap.textContent = it.label;
      card.appendChild(thumb); card.appendChild(cap); grid.appendChild(card);
    });
  });
}

/* ---------- Lightbox ---------- */
function openLightbox(src, label){
  const lb  = document.getElementById('lightbox');
  const box = document.getElementById('lightboxMedia');
  const cap = document.getElementById('lightboxCaption');
  const isVideo = /\.(mp4|webm|ogg|mov|avi)$/i.test(src);
  box.innerHTML = isVideo ? `<video src="${src}" controls autoplay muted></video>` : `<img src="${src}" alt="${label??''}">`;
  cap.textContent = label || '';
  lb.classList.add('show');
  document.body.dataset.lbScroll = document.body.style.overflow || '';
  document.body.style.overflow = 'hidden';
  document.addEventListener('keydown', onLightboxKey);
}
function closeLightbox(){
  const lb  = document.getElementById('lightbox');
  const box = document.getElementById('lightboxMedia');
  const cap = document.getElementById('lightboxCaption');
  lb.classList.remove('show'); box.innerHTML=''; cap.textContent='';
  document.body.style.overflow = document.body.dataset.lbScroll || ''; delete document.body.dataset.lbScroll;
  document.removeEventListener('keydown', onLightboxKey);
}
function onLightboxKey(e){ if(e.key==='Escape') closeLightbox(); }

/* ---------- ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒ»ãƒ­ã‚°ãƒ»ãƒãƒ•çµµæ–‡å­— ---------- */
function updateEnergy(){ document.querySelectorAll('.energy-orb').forEach((o,i)=>{ i<game.energy ? o.classList.add('filled') : o.classList.remove('filled'); }); }
function updateLog(msg){ document.getElementById('battleLog').textContent = msg; }
function updateBuffEmoji(){
  const e = document.getElementById('buffEmoji');
  const f = game.teamBuff.fire   ? 'ğŸ”¥' : 'â—»ï¸';
  const p = game.teamBuff.prism  ? 'ğŸ’' : 'â—»ï¸';
  const s = game.teamBuff.shadow ? 'ğŸŒ™' : 'â—»ï¸';
  e.textContent = `${f}${p}${s}`;
}

/* ---------- ãƒœã‚¿ãƒ³æœ‰åŠ¹/ç„¡åŠ¹ ---------- */
function enableActionButtons(){ ['attackBtn','skillBtn','guardBtn','dodgeBtn','specialSkillBtn','specialBtn'].forEach(id=>{const el=document.getElementById(id); if(el){el.disabled=false; el.style.opacity='1'; el.style.cursor='pointer';}}); }
function disableActionButtons(){ ['attackBtn','skillBtn','guardBtn','dodgeBtn','specialSkillBtn','specialBtn'].forEach(id=>{const el=document.getElementById(id); if(el){el.disabled=true; el.style.opacity='.5'; el.style.cursor='not-allowed';}}); }
</script>

<script>
  // 100vhãŒç¸®ã‚€å•é¡Œå¯¾ç­–ï¼š--vh ã‚’è¨­å®š
  function setVh() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  }
  setVh();
  window.addEventListener('resize', setVh);
</script>

</body>
</html>
